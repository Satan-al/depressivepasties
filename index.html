<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>DepressivePasties</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="telegram_link_styles.css">
  <style>
    :root {
      --bg: #0b1216; --fg: #e6edf3; --muted: #9aa4af;
      --accent: #16c7b7; --accent-2: #0ea5a0;
      --panel: #0f1722; --panel2: #0b1420; --border: #1e2633;
      --input-bg: #0b1420; --input-border: #223044;
      --blur: 14px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:var(--fg);font-family:'Open Sans',system-ui,sans-serif;font-size:15px;line-height:1.6}
    
    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:rgba(30,38,51,0.3);border-radius:4px}
    ::-webkit-scrollbar-thumb{background:linear-gradient(180deg,rgba(22,199,183,0.4),rgba(14,165,160,0.4));border-radius:4px;transition:background 0.2s}
    ::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,rgba(22,199,183,0.6),rgba(14,165,160,0.6))}
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —ç–º–æ–¥–∑–∏ */
    @keyframes reaction-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    
    @keyframes reaction-bg-flash {
      0% { background-color: rgba(22,199,183,0.1); }
      50% { background-color: rgba(22,199,183,0.4); }
      100% { background-color: rgba(10,20,30,0.78); }
    }
    
    .reaction-clicked {
      animation: reaction-pulse 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55),
                 reaction-bg-flash 0.6s ease-out;
    }
    
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    header{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding:14px 24px;
      background:linear-gradient(180deg,rgba(15,23,34,0.95),rgba(11,20,32,0.98));
      border-bottom:1px solid rgba(22,199,183,0.15);
      position:sticky;top:0;z-index:100;
      box-shadow:0 4px 20px rgba(0,0,0,0.4), 0 0 40px rgba(22,199,183,0.05);
      backdrop-filter:blur(12px);
    }
    .brand{
      font-family:'Montserrat',sans-serif;font-weight:800;font-size:1.7em;
      background:linear-gradient(135deg,#16c7b7,#14e3d0,#16c7b7);
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
      filter:drop-shadow(0 0 12px rgba(22,199,183,0.4));
      letter-spacing:.05em;
    }

    .btn{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#041f1e;border:0;padding:10px 16px;border-radius:12px;font-weight:800;font-size:.95em;cursor:pointer;
      transition:transform .1s ease,filter .2s ease;box-shadow:0 6px 18px rgba(22,199,183,.18); white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.02);transform:translateY(-1px)}
    .btn.ghost{
      background:rgba(10,20,30,.78); color:var(--fg); border:1px solid var(--border); box-shadow:none; backdrop-filter:blur(8px)
    }
    .btn.small{padding:8px 12px;border-radius:10px;font-weight:700}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c); color:#fff; box-shadow:0 6px 18px rgba(239,68,68,.18)}

    #status{margin-left:auto;display:flex;align-items:center;gap:10px;color:var(--muted);font-size:.9em}
    .dot{width:12px;height:12px;border-radius:999px;background:#666;box-shadow:0 0 0 2px rgba(255,255,255,.06) inset}
    .dot.ok{background:#36D399}.dot.warn{background:#F87171}

    .stage{position:relative;display:flex;align-items:center;justify-content:center;width:100%;height:100%;overflow:hidden}
    .videoWrap{position:relative;width:100%;height:100%;max-width:100vw;max-height:100vh;background:#000;overflow:hidden;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--border)}
    /* –£–±–∏—Ä–∞–µ–º –∫—Ä–∞—Å–Ω—É—é —Ä–∞–º–∫—É –≤ overlay —Ä–µ–∂–∏–º–µ */
    body.overlay-mode #overlay{border:none !important;}
    iframe{width:100%;height:100%;border:0;display:block;object-fit:contain}
    #overlay{position:absolute;inset:0;width:100%;height:100%;touch-action:none;pointer-events:auto}
    #fx-layer{position:absolute;inset:0;pointer-events:none;overflow:visible}

    /* CHAT: —Å–∞–π—Ç (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å) */
    .chat-panel{
      position:fixed; left:16px; top:96px; width:340px; max-height:65vh; z-index:120;
      background:linear-gradient(145deg,rgba(15,23,34,0.85),rgba(11,20,32,0.9));
      border:1px solid rgba(22,199,183,0.2);
      border-radius:16px;
      backdrop-filter:blur(16px);
      display:flex; flex-direction:column; overflow:hidden; resize: both; min-width:260px; min-height:160px; height:min(50vh, 420px);
      box-shadow:0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(22,199,183,0.1) inset;
      user-select:none;
      resize:both; /* –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
      min-width:280px;
      min-height:200px;
    }
    .chat-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
      color:var(--accent); font-weight:700; font-size:0.9em; letter-spacing:0.05em;
      border-bottom:1px solid rgba(22,199,183,0.15);
      background:rgba(22,199,183,0.05);
      cursor:move;
      touch-action: none;
    }
    .chat-header-left{display:flex;align-items:center;gap:8px}
    .chat-badge{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#041f1e;font-size:0.75em;font-weight:900;padding:2px 8px;border-radius:10px;min-width:20px;text-align:center}
    .chat-body{
      padding:12px; display:flex; flex-direction:column; gap:8px;
      overflow-y:auto; overflow-x:hidden;
      min-height:120px; max-height:50vh;
      scrollbar-width:thin;
      scrollbar-color:rgba(22,199,183,0.4) rgba(30,38,51,0.3);
    }
    .chat-body::-webkit-scrollbar{width:8px}
    .chat-body::-webkit-scrollbar-track{background:rgba(30,38,51,0.3);border-radius:4px}
    .chat-body::-webkit-scrollbar-thumb{background:linear-gradient(180deg,rgba(22,199,183,0.4),rgba(14,165,160,0.4));border-radius:4px}
    .chat-body::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,rgba(22,199,183,0.6),rgba(14,165,160,0.6))}
    .chat-msg{
      background:linear-gradient(135deg,rgba(22,199,183,0.08),rgba(14,165,160,0.05));
      border:1px solid rgba(22,199,183,0.15);
      border-radius:12px;
      padding:10px 12px;
      word-break:break-word;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
      transition:transform 0.15s ease, box-shadow 0.15s ease;
      cursor:pointer;
      position:relative;
    }
    .chat-msg:hover{
      transform:translateX(2px);
      box-shadow:0 4px 12px rgba(22,199,183,0.15);
    }
    /* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .chat-msg.own-message{
      background:linear-gradient(135deg,rgba(22,199,183,0.18),rgba(14,165,160,0.12));
      border:1px solid rgba(22,199,183,0.3);
    }
    .chat-msg.own-message .chat-msg-header{
      flex-direction:row-reverse;
    }
    .chat-msg.replying{
      border:2px solid var(--accent);
      box-shadow:0 0 12px rgba(22,199,183,0.4);
      animation:pulse-reply 1s ease-in-out infinite;
    }
    @keyframes pulse-reply {
      0%, 100% { box-shadow:0 0 12px rgba(22,199,183,0.4); }
      50% { box-shadow:0 0 20px rgba(22,199,183,0.6); }
    }
    .chat-msg-reply-preview{
      background:rgba(22,199,183,0.1);
      border-left:3px solid var(--accent);
      border-radius:6px;
      padding:6px 8px;
      margin-bottom:6px;
      font-size:0.85em;
      color:var(--muted);
      cursor:pointer;
      transition:background 0.2s;
    }
    .chat-msg-reply-preview:hover{
      background:rgba(22,199,183,0.15);
    }
    .chat-msg-reply-preview b{
      color:var(--accent);
      font-size:0.9em;
    }
    .chat-msg-reply-cancel{
      position:absolute;
      top:0;
      right:0;
      background:rgba(239,68,68,0.8);
      border:none;
      color:#fff;
      padding:4px 8px;
      border-radius:0 12px 0 8px;
      cursor:pointer;
      font-size:0.75em;
      font-weight:700;
      opacity:0;
      transition:opacity 0.2s;
    }
    .chat-msg.replying .chat-msg-reply-cancel{
      opacity:1;
    }
    .chat-msg-reply-cancel:hover{
      background:rgba(239,68,68,1);
    }
    /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
    .chat-context-menu{
      position:fixed;
      background:linear-gradient(145deg,rgba(15,23,34,0.98),rgba(11,20,32,1));
      border:1px solid rgba(22,199,183,0.3);
      border-radius:8px;
      padding:4px;
      z-index:9999;
      box-shadow:0 8px 24px rgba(0,0,0,0.6);
      backdrop-filter:blur(12px);
      min-width:120px;
      display:none;
    }
    .chat-context-menu.show{
      display:block;
    }
    .chat-context-menu-item{
      padding:8px 12px;
      cursor:pointer;
      border-radius:6px;
      transition:background 0.2s;
      color:var(--fg);
      font-size:0.9em;
    }
    .chat-context-menu-item:hover{
      background:rgba(22,199,183,0.2);
    }
    .chat-context-menu-item.danger{
      color:#ef4444;
    }
    .chat-context-menu-item.danger:hover{
      background:rgba(239,68,68,0.2);
    }
    /* –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .chat-msg-editing{
      border:2px solid #fbbf24;
      box-shadow:0 0 12px rgba(251,191,36,0.4);
      animation:pulse-edit 1s ease-in-out infinite;
    }
    @keyframes pulse-edit {
      0%, 100% { box-shadow:0 0 12px rgba(251,191,36,0.4); }
      50% { box-shadow:0 0 20px rgba(251,191,36,0.6); }
    }
    .chat-msg-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .chat-msg-actions{
      display:flex;
      gap:4px;
      opacity:0;
      transition:opacity 0.2s;
    }
    .chat-msg:hover .chat-msg-actions{
      opacity:1;
    }
    .chat-msg-action-btn{
      background:rgba(22,199,183,0.2);
      border:none;
      color:var(--fg);
      padding:4px 8px;
      border-radius:6px;
      cursor:pointer;
      font-size:0.75em;
      font-weight:700;
      transition:background 0.2s;
    }
    .chat-msg-action-btn:hover{
      background:rgba(22,199,183,0.4);
    }
    .chat-msg-action-btn.danger{
      background:rgba(239,68,68,0.2);
      color:#ef4444;
    }
    .chat-msg-action-btn.danger:hover{
      background:rgba(239,68,68,0.4);
    }
    .chat-input{
      display:flex; gap:8px; padding:10px;
      border-top:1px solid rgba(22,199,183,0.15);
      background:rgba(0,0,0,0.2);
    }
    .chat-input input{
      flex:1;
      background:rgba(11,20,32,0.6);
      border:1px solid rgba(22,199,183,0.25);
      color:var(--fg);
      padding:10px 14px;
      border-radius:10px;
      font-size:.95em;
      outline:none;
      transition:border-color 0.2s, box-shadow 0.2s;
    }
    .chat-input input:focus{
      border-color:rgba(22,199,183,0.5);
      box-shadow:0 0 0 3px rgba(22,199,183,0.1);
    }
    .chat-hidden{display:none}

    /* CHAT: –æ–≤–µ—Ä–ª–µ–π (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ 15—Å, –° –ü–û–õ–ï–ú –í–í–û–î–ê) - –°–ö–†–´–¢ –û–¢ OBS */
    .chat-overlay{
      position:absolute; left:16px; bottom:16px; width:min(40vw,480px); z-index:115;
      background:linear-gradient(145deg,rgba(15,23,34,0.92),rgba(11,20,32,0.95));
      border:1px solid rgba(22,199,183,0.25); border-radius:14px; backdrop-filter:blur(12px);
      display:flex; flex-direction:column; overflow:hidden; resize: both; min-width:260px; min-height:160px; height:min(50vh, 420px); 
      box-shadow:0 8px 24px rgba(0,0,0,.5), 0 0 0 1px rgba(22,199,183,0.15) inset;
      opacity:0; transform:translateY(10px); transition:opacity .25s ease, transform .25s ease; pointer-events:none;
      /* –ö–†–ò–¢–ò–ß–ù–û: —Å–æ–∑–¥–∞–µ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–π –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞ */
      will-change: transform, opacity;
      isolation: isolate;
      contain: layout style paint;
    }
    .chat-overlay.show{opacity:1; transform:none; pointer-events:auto !important;}
    .chat-overlay.show *{pointer-events:auto !important;}
    .chat-overlay .chat-body{padding:10px; gap:6px; flex:1; overflow-y:auto; max-height:none;}
    .chat-overlay .chat-msg{background:linear-gradient(135deg,rgba(22,199,183,0.08),rgba(14,165,160,0.05)); border:1px solid rgba(22,199,183,0.15);}
    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –≤ overlay-—á–∞—Ç–µ */
    .chat-overlay .chat-input{display:flex; gap:6px; padding:8px; border-top:1px solid rgba(22,199,183,0.15); background:rgba(0,0,0,0.3);}
    .chat-overlay .chat-input input{flex:1; background:rgba(11,20,32,0.7); border:1px solid rgba(22,199,183,0.3); color:var(--fg); padding:8px 12px; border-radius:8px; font-size:.9em; outline:none;}
    .chat-overlay .chat-input input:focus{border-color:rgba(22,199,183,0.6); box-shadow:0 0 0 2px rgba(22,199,183,0.15);}
    .chat-overlay .chat-input .btn{padding:8px 14px; font-size:.85em;}

    /* EMOJI particle ‚Äî –ª–µ—Ç—è—â–∏–µ —ç–º–æ–¥–∑–∏ —Å —Ü–≤–µ—Ç–Ω–æ–π –æ–±–≤–æ–¥–∫–æ–π */
    .emoji { 
      position: absolute; 
      font-size: 40px; 
      pointer-events: none; 
      user-select: none;
      will-change: transform, opacity;
    }
    .emoji.stroke {
      text-shadow:
        -3px -3px 0 var(--emoji-stroke),
        3px -3px 0 var(--emoji-stroke),
        -3px 3px 0 var(--emoji-stroke),
        3px 3px 0 var(--emoji-stroke),
        -3px 0 0 var(--emoji-stroke),
        3px 0 0 var(--emoji-stroke),
        0 -3px 0 var(--emoji-stroke),
        0 3px 0 var(--emoji-stroke),
        0 0 12px var(--emoji-stroke) !important; /* !important –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏ —Å—Ç–∏–ª—è–º–∏ */
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4)) !important; /* –¢–µ–Ω—å –¥–ª—è –≤—Å–µ–≥–æ */
    }

    /* –î–ª—è PNG: –æ—Ç–¥–µ–ª—å–Ω–æ filter —Å !important */
    .emoji.stroke img {
      filter: 
        drop-shadow(-3px -3px 0 var(--emoji-stroke))
        drop-shadow(3px -3px 0 var(--emoji-stroke))
        drop-shadow(-3px 3px 0 var(--emoji-stroke))
        drop-shadow(3px 3px 0 var(--emoji-stroke))
        drop-shadow(-3px 0 0 var(--emoji-stroke))
        drop-shadow(3px 0 0 var(--emoji-stroke))
        drop-shadow(0 -3px 0 var(--emoji-stroke))
        drop-shadow(0 3px 0 var(--emoji-stroke))
        drop-shadow(0 0 12px var(--emoji-stroke)) !important;
    }

    /* BLUR GATE */
    .blur-wrap{filter:blur(var(--blur)); pointer-events:none; user-select:none}

    .gate{
      position:fixed; inset:0; display:grid; place-items:center; z-index:9999;
      background:linear-gradient(180deg, rgba(11,18,22,.82), rgba(11,18,22,.92));
      backdrop-filter: blur(6px);
      pointer-events:auto;
    }
    .gate-card{
      width:min(600px,92vw); background:rgba(12,20,28,.9); border:1px solid var(--border);
      border-radius:18px; padding:24px; text-align:center; box-shadow:0 12px 36px rgba(0,0,0,.5);
      transform:translateZ(0);
    }
    .gate-title{font-family:'Montserrat',sans-serif; font-weight:800; font-size:28px; color:var(--accent); margin-bottom:12px}
    .gate-sub{color:var(--muted); margin-bottom:8px}
    .gate-hint{color:#ef9a9a; font-size:.95em; min-height:1.2em; margin-bottom:10px; opacity:0; transition:opacity .2s}
    .gate-hint.show{opacity:1}

    .gate-form{display:grid; grid-template-columns:1fr 170px; gap:14px; align-items:center}
    .field{display:flex; align-items:center; gap:10px; justify-content:space-between}
    .field label{color:var(--muted); font-weight:700}
    .in{
      background:var(--input-bg); color:var(--fg); border:1px solid var(--input-border); border-radius:12px; padding:12px 14px; outline:none
    }
    .in.big{font-size:18px}
    .in[type="color"]{appearance:none;width:44px;height:44px;border-radius:10px;border:1px solid var(--input-border);padding:2px;background:var(--input-bg);cursor:pointer}
    .in[type="color"]::-webkit-color-swatch{border:none;border-radius:6px}

    /* error effects */
    @keyframes shake {
      10%, 90% { transform: translateX(-2px); }
      20%, 80% { transform: translateX(4px); }
      30%, 50%, 70% { transform: translateX(-6px); }
      40%, 60% { transform: translateX(6px); }
    }
    .gate-card.error { animation: shake .35s ease; }
    .in.error { border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.2); }

    footer{padding:14px 20px;color:var(--muted);font-size:.9em;background:var(--panel2);border-top:1px solid var(--border);text-align:center;box-shadow:0 -4px 12px rgba(0,0,0,.32)}
    .hidden{display:none!important}

    @media (max-width:768px){
      header{flex-direction:column;align-items:stretch;gap:10px;padding:10px}
      .brand{text-align:center;font-size:1.4em}
      #status{margin-left:0;justify-content:center}
      .chat-panel{left:8px; top:auto; bottom:80px; width:calc(100vw - 16px); max-width:420px; max-height:45vh}
      .chat-body{max-height:35vh}
      .gate-form{grid-template-columns:1fr}
      .field{justify-content:flex-start}
      #reactionsBar{flex-wrap:wrap;justify-content:center;margin-left:0}
    }
    /* –í –∫–æ–Ω—Ü–µ —Å–µ–∫—Ü–∏–∏ <style> */
    .gate-form .btn {
      pointer-events: auto; /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ */
      opacity: 1; /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ */
    }
    .gate-form .btn:disabled {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
</head>
<body>
<div class="app">
  <header id="mainHeader">
    <div class="brand">DepressivePasties</div>

    <!-- –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
    <div style="display:flex;gap:8px;align-items:center;margin-left:8px" id="toolsBar">
      <button class="btn small" id="toolToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≥–æ–ª–æ—Å/—Ä–∏—Å–æ–≤–∞–Ω–∏–µ">–†–∏—Å–æ–≤–∞—Ç—å</button>
      <button class="btn ghost small" id="toolErase" title="–õ–∞—Å—Ç–∏–∫">–õ–∞—Å—Ç–∏–∫</button>
      <button class="btn ghost small danger" id="toolClear" title="–û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <!-- –†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏ -->
      <div style="display:flex;gap:6px;align-items:center;margin-left:8px;padding-left:8px;border-left:1px solid var(--border)">
        <label style="color:var(--muted);font-size:0.85em;font-weight:600">–†–∞–∑–º–µ—Ä:</label>
        <input type="range" id="brushSizeSlider" min="1" max="20" value="4" style="width:100px;cursor:pointer">
        <span id="brushSizeValue" style="color:var(--accent);font-weight:700;font-size:0.9em;min-width:28px;text-align:center">4px</span>
      </div>
    </div>

    <!-- —Ä–µ–∞–∫—Ü–∏–∏ -->
    <div id="reactionsBar" style="display:flex;gap:8px;align-items:center;margin-left:8px">
      <button class="btn ghost small" data-emo="üëç" style="font-size:1.4em;padding:8px 14px">üëç</button>
      <button class="btn ghost small" data-emo="üëé" style="font-size:1.4em;padding:8px 14px">üëé</button>
      <button class="btn ghost small" data-emo="‚ù§Ô∏è" style="font-size:1.4em;padding:8px 14px">‚ù§Ô∏è</button>
      <button class="btn ghost small" data-emo="üòÇ" style="font-size:1.4em;padding:8px 14px">üòÇ</button>
      <button class="btn ghost small" data-emo="üòÆ" style="font-size:1.4em;padding:8px 14px">üòÆ</button>
      <button class="btn ghost small" data-emo="üò¢" style="font-size:1.4em;padding:8px 14px">üò¢</button>
      <button class="btn ghost small" data-emo="üî•" style="font-size:1.4em;padding:8px 14px">üî•</button>
      <button class="btn ghost small" data-emo="ü§°" style="font-size:1.4em;padding:8px 14px">ü§°</button>
      <button class="btn ghost small" data-emo="ü§¨" style="font-size:1.4em;padding:8px 14px">ü§¨</button>
      <button class="btn ghost small" data-emo="üç∑" style="font-size:1.4em;padding:8px 14px">üç∑</button>
      <button class="btn ghost small" data-emo="üßê" style="font-size:1.4em;padding:8px 14px">üßê</button>
      <button class="btn ghost small" data-emo="üíÉ" style="font-size:1.4em;padding:8px 14px">üíÉ</button>
      <button class="btn ghost small" data-emo="üö©" style="font-size:1.4em;padding:8px 14px">üö©</button>
      <button class="btn ghost small" data-emo="ü§∑‚Äç‚ôÇÔ∏è" style="font-size:1.4em;padding:8px 14px">ü§∑‚Äç‚ôÇÔ∏è</button>
      <button class="btn ghost small" data-emo="üôÑ" style="font-size:1.4em;padding:8px 14px">üôÑ</button>
      <button class="btn ghost small" data-emo="üíî" style="font-size:1.4em;padding:8px 14px">üíî</button>
      <button class="btn ghost small" data-emo="ü§Ø" style="font-size:1.4em;padding:8px 14px">ü§Ø</button>
      <button class="btn ghost small" data-emo="üîî" style="font-size:1.4em;padding:8px 14px">üîî</button>
      <button class="btn ghost small" data-reaction-type="png" data-reaction-src="images/crying.png" data-reaction-key="–ø–ª–∞—á—É" style="font-size:1.4em;padding:8px 14px">
        <img src="images/crying.png" alt="–ü–ª–∞—á—É" style="width: 24px; height: 24px; vertical-align: middle;">
      </button>
      <button class="btn ghost small" data-reaction-type="png" data-reaction-src="images/dancing.png" data-reaction-key="—Ç–∞–Ω—Ü—É—é" style="font-size:1.4em;padding:8px 14px">
        <img src="images/dancing.png" alt="–¢–∞–Ω—Ü—É—é" style="width: 24px; height: 24px; vertical-align: middle;">
      </button>
    </div>

    <button class="btn ghost small" id="logout" style="margin-left:auto">–í—ã–π—Ç–∏</button>

    <div id="status" style="margin-left:6px">
      <span class="dot" id="dot-auth" title="–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"></span>
      <span id="status-text">–û—Ñ—Ñ–ª–∞–π–Ω</span>
    </div>
  </header>

  <!-- CHAT: —Å–∞–π—Ç -->
  <aside class="chat-panel" id="chatPanel">
    <div class="chat-header" id="chatDragHandle">
      <div class="chat-header-left">
        <span>–ß–∞—Ç</span>
        <span class="chat-badge hidden" id="chatBadge">0</span>
        <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram -->
        <button class="btn ghost small link-tg-btn" id="linkTelegramBtn" onclick="showLinkModal()" title="–°–≤—è–∑–∞—Ç—å —Å Telegram">
          üîó TG
        </button>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost small" id="chatNotifications" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">üîî</button>
        <button class="btn ghost small" id="chatToggle">–°–≤–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>
    <div class="chat-body" id="chatListSite"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" />
      <button class="btn small" id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </aside>

  <main class="stage" id="contentWrap">
    <div class="videoWrap" id="videoWrap">
      <iframe id="player" allow="autoplay; microphone; camera" referrerpolicy="no-referrer"></iframe>
      <canvas id="overlay"></canvas>
      <div id="fx-layer"></div>
      <!-- CHAT: –æ–≤–µ—Ä–ª–µ–π –° –ü–û–õ–ï–ú –í–í–û–î–ê -->
      <div class="chat-overlay" id="chatOverlay">
        <div class="chat-body" id="chatListOverlay"></div>
        <div class="chat-input">
          <input id="chatInputOverlay" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" />
          <button class="btn small" id="chatSendOverlay">‚Üí</button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div>–¢–∞–ø –ø–æ –≤–∏–¥–µ–æ —Å—Ç–∞–≤–∏—Ç/–ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä. Alt+F7 ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —á–∞—Ç –≤ –æ–≤–µ—Ä–ª–µ–µ. –ü–ò–ù –≤—Ö–æ–¥–∞: 1111.</div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost small danger" id="btnDeleteVotes" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≥–æ–ª–æ—Å–∞">–£–¥–∞–ª–∏—Ç—å –≥–æ–ª–æ—Å–∞</button>
      </div>
    </div>
  </footer>
</div>

<!-- –í–•–û–î–ù–û–ô –ì–ï–ô–¢ -->
<div class="gate" id="gate">
  <div class="gate-card" id="gateCard">
    <div class="gate-title">DepressivePasties</div>
    <div class="gate-sub">–í–≤–µ–¥–∏ –ò–º—è, –≤—ã–±–µ—Ä–∏ –¶–≤–µ—Ç –∏ –ü–ò–ù. –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–∫–∞ –ø–æ–¥ –∑–∞–º–∫–æ–º üëÄ</div>
    <div class="gate-hint" id="gateHint"></div>
    <div class="gate-form">
      <div class="field"><label for="gateName">–ò–º—è</label><input id="gateName" class="in big" placeholder="–¢–≤–æ—ë –∏–º—è"/></div>
      <div class="field"><label for="gateColor">–¶–≤–µ—Ç</label><input id="gateColor" type="color" class="in" value="#16c7b7"/></div>
      <div class="field"><label for="gatePin">–ü–ò–ù</label><input id="gatePin" class="in big" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" pattern="[0-9]*" maxlength="8"/></div>
      <div class="field"><span></span><button class="btn" id="gateEnter" type="button">–í–æ–π—Ç–∏</button></div>
    </div>
  </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —á–∞—Ç–∞ -->
<div class="chat-context-menu" id="chatContextMenu">
  <div class="chat-context-menu-item" id="contextReply">‚Ü©Ô∏è –û—Ç–≤–µ—Ç–∏—Ç—å</div>
  <div class="chat-context-menu-item" id="contextEdit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
  <div class="chat-context-menu-item danger" id="contextDelete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>
</div>

<script type="module">
  window.isOverlayHotkeys = new URLSearchParams(location.search).get('overlay')==='1';
  /* ==== FIREBASE ==== */
  const firebaseConfig = {
    apiKey: "AIzaSyAcrLDWHWA_diaVHQwtFUeWqq3WAzMYBnc",
    authDomain: "dpgames-66d73.firebaseapp.com",
    databaseURL: "https://dpgames-66d73-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dpgames-66d73",
    storageBucket: "dpgames-66d73.firebasestorage.app",
    messagingSenderId: "734650657253",
    appId: "1:734650657253:web:6c98ad8e72a4156e7be70c",
    measurementId: "G-JBK5DRBTXN"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove, push, update, child, query, orderByChild, limitToLast,serverTimestamp, onChildAdded, onChildRemoved, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const FIXED_VIEW = "https://vdo.ninja/?view=DepressivePasties";
  const SESSION_KEY = "DepressivePasties";

  const $ = (s)=>document.querySelector(s);

  // header controls
  const toolToggle=$('#toolToggle'), toolErase=$('#toolErase'), toolClear=$('#toolClear');
  const reactionsBar=$('#reactionsBar'); 
  reactionsBar.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ
      b.classList.add('reaction-clicked');
      setTimeout(()=> b.classList.remove('reaction-clicked'), 400);
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ–∞–∫—Ü–∏–∏
      const type = b.dataset.reactionType || 'emoji';
      if (type === 'png') {
        const src = b.dataset.reactionSrc;
        const key = b.dataset.reactionKey;
        sendReaction({ type: 'png', src, key }); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è PNG
      } else {
        sendReaction(b.dataset.emo || b.textContent); // –°—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è —ç–º–æ–¥–∑–∏
      }
    });
  });


  
  
  // Hotkeys for reactions (host too)
  // Overlay (?overlay=1): Alt+QWETYASDFGZXCVB (15 –∫–Ω–æ–ø–æ–∫, –ë–ï–ó R –¥–ª—è Nvidia!)
  // Browser: Numpad1..7 (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ)
  window.addEventListener('keydown', (e)=>{
    if (['INPUT','TEXTAREA'].includes((document.activeElement||{}).tagName)) return;
    if (e.repeat) return;

    let idx = undefined;
    if (window.isOverlayHotkeys){
      if (!e.altKey || e.ctrlKey || e.metaKey) return;
      // –£–î–û–ë–ù–ê–Ø –†–ê–°–ö–õ–ê–î–ö–ê –ë–ï–ó R: Alt+QWETYASDFGZXCVB + UIO (18 –∫–Ω–æ–ø–æ–∫)
      const mapOverlay = {
        'KeyQ': 0,  // üëç
        'KeyW': 1,  // üëé
        'KeyE': 2,  // ‚ù§Ô∏è
        'KeyT': 3,  // üòÇ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º R –¥–ª—è Nvidia!)
        'KeyY': 4,  // üòÆ
        'KeyA': 5,  // üò¢
        'KeyS': 6,  // üî•
        'KeyD': 7,  // ü§°
        'KeyF': 8,  // ü§¨
        'KeyG': 9,  // üç∑
        'KeyZ': 10, // üßê
        'KeyX': 11, // üíÉ
        'KeyC': 12, // üö©
        'KeyV': 13, // ü§∑‚Äç‚ôÇÔ∏è
        'KeyB': 14, // üôÑ
        'KeyU': 15, // 16-—è —ç–º–æ–¥–∑–∏
        'KeyI': 16, // 17-—è —ç–º–æ–¥–∑–∏
        'KeyO': 17, // 18-—è —ç–º–æ–¥–∑–∏
      };
      idx = mapOverlay[e.code];
    } else {
      // Browser: Numpad 1..7 –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
      if (e.altKey || e.ctrlKey || e.metaKey || e.shiftKey) return;
      const mapBrowser = {
        'Numpad1': 0,
        'Numpad2': 1,
        'Numpad3': 2,
        'Numpad4': 3,
        'Numpad5': 4,
        'Numpad6': 5,
        'Numpad7': 6,
      };
      idx = mapBrowser[e.code];
    }

    if (idx !== undefined){
      const btns = reactionsBar.querySelectorAll('button');
      if (btns[idx]){
        const b = btns[idx];
        b.classList.add('reaction-clicked');
        setTimeout(()=> b.classList.remove('reaction-clicked'), 300);
        sendReaction(b.dataset.emo||b.textContent);
        e.preventDefault();
      }
    }
  });
  const logoutBtn=$('#logout');
  const $statusText=$('#status-text'), $dotAuth=$('#dot-auth');

  // footer admin controls
  const btnDeleteVotes=$('#btnDeleteVotes');

  // canvases / layers
  const canvas=$('#overlay'), ctx=canvas.getContext('2d');
  const fxLayer = $('#fx-layer');
  const $player=$('#player');

  // gate fields
  const gate=$('#gate'), gateName=$('#gateName'), gateColor=$('#gateColor'), gatePin=$('#gatePin'), gateEnter=$('#gateEnter');
  const gateCard = document.getElementById('gateCard');
  const gateHint = document.getElementById('gateHint');

  // chat
  const chatPanel=$('#chatPanel'); const chatToggle=$('#chatToggle'); const chatNotifications=$('#chatNotifications');
  const chatListSite=$('#chatListSite'), chatInput=$('#chatInput'), chatSend=$('#chatSend');
  const chatOverlay=$('#chatOverlay'), chatListOverlay=$('#chatListOverlay');
  const chatInputOverlay=$('#chatInputOverlay'), chatSendOverlay=$('#chatSendOverlay');
  const chatDragHandle=$('#chatDragHandle'); const chatBadge=$('#chatBadge');
  const chatContextMenu = $('#chatContextMenu');
  const contextReply = $('#contextReply');
  const contextEdit = $('#contextEdit');
  const contextDelete = $('#contextDelete');

  // Reply state
  let replyToMessage = null;
  
  // Edit state
  let editingMessage = null;
  let replyIndicatorElement = null;

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  const DEFAULT_COLOR = '#16c7b7';
  
  // –ü–†–û–í–ï–†–ö–ê URL –ü–ê–†–ê–ú–ï–¢–†–ê ?overlay=1 –î–õ–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –í–ö–õ–Æ–ß–ï–ù–ò–Ø OVERLAY –†–ï–ñ–ò–ú–ê
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('overlay') === '1') {
    localStorage.setItem('cc_mode', 'overlay');
    console.log('üé¨ Overlay mode activated via URL parameter');
    document.body.classList.add('overlay-mode'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è CSS
  }
  
  const state = {
    id: localStorage.getItem('cc_id') || crypto.randomUUID(),
    name: localStorage.getItem('cc_name') || '',
    color: localStorage.getItem('cc_color') || DEFAULT_COLOR,
    mode: localStorage.getItem('cc_mode') || 'watch',
    tool: localStorage.getItem('cc_tool') || 'vote',
    authed: false,
    points: new Map(),
    strokes: new Map(),
    presence: new Map(),
    localChat: JSON.parse(localStorage.getItem('cc_chat_cache')||'[]'),
    notifications: localStorage.getItem('cc_notifications') !== 'false',
    unreadCount: 0,
    lastReadTs: Date.now(),
    currentStroke: null, // —Ç–µ–∫—É—â–∞—è —Ä–∏—Å—É–µ–º–∞—è –ª–∏–Ω–∏—è
  };
  localStorage.setItem('cc_id', state.id);



  function saveState(){
    localStorage.setItem('cc_name',state.name);
    localStorage.setItem('cc_color',state.color);
    localStorage.setItem('cc_mode',state.mode);
    localStorage.setItem('cc_auth', 'true'); // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É, —á—Ç–æ –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω
  }

  /* ======= SIZE ======= */
  function sizeCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const w = Math.round(window.innerWidth * dpr);
    const h = Math.round(window.innerHeight * dpr);
    canvas.width=w; canvas.height=h;
    canvas.style.width=window.innerWidth+'px';
    canvas.style.height=window.innerHeight+'px';
  }
  sizeCanvas();
  let resizeTimer; window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(sizeCanvas, 120); });

  function videoRect(){
    const dpr = window.devicePixelRatio||1;
    
    // –í overlay —Ä–µ–∂–∏–º–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤—Å–µ–≥–æ canvas (–±–µ–∑ iframe)
    if (isOverlayMode()) {
      const cw = canvas.clientWidth, ch = canvas.clientHeight;
      return { x:0, y:0, w:cw*dpr, h:ch*dpr, cssx:0, cssy:0, cssw:cw, cssh:ch };
    }
    
    // –î–ª—è –±—Ä–∞—É–∑–µ—Ä–∞: –≤—ã—á–∏—Å–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–µ–æ —Å —É—á–µ—Ç–æ–º contain
    const videoWrap = document.getElementById('videoWrap');
    const iframe = document.getElementById('player');
    
    if (!videoWrap) {
      const cw = canvas.clientWidth, ch = canvas.clientHeight;
      return { x:0, y:0, w:cw*dpr, h:ch*dpr, cssx:0, cssy:0, cssw:cw, cssh:ch };
    }
    
    // –†–∞–∑–º–µ—Ä—ã videoWrap
    const wrapW = videoWrap.clientWidth;
    const wrapH = videoWrap.clientHeight;
    
    // –í–∏–¥–µ–æ 16:9, –≤–ø–∏—Å—ã–≤–∞–µ–º –≤ wrap —Å contain
    const videoAspect = 16/9;
    const wrapAspect = wrapW / wrapH;
    
    let videoW, videoH, videoX, videoY;
    
    if (wrapAspect > videoAspect) {
      // wrap —à–∏—Ä–µ —á–µ–º –≤–∏–¥–µ–æ - –≤–ø–∏—Å—ã–≤–∞–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
      videoH = wrapH;
      videoW = videoH * videoAspect;
      videoX = (wrapW - videoW) / 2;
      videoY = 0;
    } else {
      // wrap –≤—ã—à–µ —á–µ–º –≤–∏–¥–µ–æ - –≤–ø–∏—Å—ã–≤–∞–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ
      videoW = wrapW;
      videoH = videoW / videoAspect;
      videoX = 0;
      videoY = (wrapH - videoH) / 2;
    }
    
    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas
    const wrapRect = videoWrap.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    
    const offsetX = wrapRect.left - canvasRect.left + videoX;
    const offsetY = wrapRect.top - canvasRect.top + videoY;
    
    return { 
      x: offsetX*dpr, 
      y: offsetY*dpr, 
      w: videoW*dpr, 
      h: videoH*dpr, 
      cssx: offsetX, 
      cssy: offsetY, 
      cssw: videoW, 
      cssh: videoH 
    };
  }
  function normFromEvent(evt){
    const rect = canvas.getBoundingClientRect();
    const px = (evt.touches? evt.touches[0].clientX: evt.clientX) - rect.left;
    const py = (evt.touches? evt.touches[0].clientY: evt.clientY) - rect.top;
    const r = videoRect();
    const cx = Math.min(Math.max(px, r.cssx), r.cssx + r.cssw);
    const cy = Math.min(Math.max(py, r.cssy), r.cssy + r.cssh);
    const nx = (cx - r.cssx) / r.cssw; const ny = (cy - r.cssy) / r.cssh;
    return {x:nx,y:ny};
  }
  function pxFromNorm(nx, ny){
    const r=videoRect(); const dpr=window.devicePixelRatio||1;
    return { x:(r.x + nx*r.w), y:(r.y + ny*r.h), r };
  }

  const basePath   = `sessions/${SESSION_KEY}`;
  const pointsRoot = ref(db, `${basePath}/points`);
  const strokesRoot= ref(db, `${basePath}/strokes`);
  const presenceRootRef = ref(db, `${basePath}/presence`);
  const chatRoot   = ref(db, `${basePath}/chat`);
  const reactsRoot = ref(db, `${basePath}/reactions`);
  const ratModeRef = ref(db, `${basePath}/rat_mode`);  // –§–ª–∞–≥ RAT —Ä–µ–∂–∏–º–∞

  /* ======= PRESENCE ======= */
  async function heartbeat(){
    if (!auth.currentUser) return;
    const uid = auth.currentUser.uid;
    try{ await set(ref(db, `${basePath}/presence/${uid}`), { id:uid, name: getDisplayName(state)||'–ß—É–∂–æ–π', color:state.color, ts:Date.now() }); }catch{}
  }
  setInterval(heartbeat, 8000);

  onValue(presenceRootRef, (snap)=>{
    const val=snap.val()||{}; state.presence.clear();
    const now=Date.now();
    for (const [uid,p] of Object.entries(val)){
      if (now - (p.ts||0) <= 12000){ state.presence.set(uid, p); }
    }
  });

  /* ======= DATA LISTENERS ======= */
  onValue(pointsRoot, (snap)=>{
    const val=snap.val()||{}; 
    state.points.clear(); 
    for (const [id,p] of Object.entries(val)) state.points.set(id,p);
  });
  onValue(strokesRoot, (snap)=>{
    const val=snap.val()||{}; state.strokes.clear(); for (const [k,s] of Object.entries(val)) state.strokes.set(k,s);
  });
// === CHAT ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ ===
const msgs = [];               // –µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
let lastReadT = state.lastReadTs || 0; // –¥–ª—è –±–µ–π–¥–∂–∏–∫–∞

const getT = (m)=> (m.t ?? m.ts ?? 0); // —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –ø–æ–ª–µ–º

(function setupChat(){
  // –í–ê–ñ–ù–û: –≤ rules –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å .indexOn: ["t"]
  const q = query(chatRoot, orderByChild('t'), limitToLast(100));

  onChildAdded(q, (snap)=>{
    const m = { key: snap.key, ...snap.val() };

    // –¥–µ–¥—É–ø
    const i = msgs.findIndex(x=>x.key===m.key);
    if (i>=0) msgs[i]=m; else msgs.push(m);

    // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ (t, key)
    msgs.sort((a,b)=> getT(a) - getT(b) || (a.key < b.key ? -1 : 1));

    // –±–µ–π–¥–∂–∏–∫ "–Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö" ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –∏ –Ω–æ–≤–µ–µ –ø–æ—Ä–æ–≥–∞
    const isForeign = (m.uid !== (auth.currentUser?.uid || state.id));
    if (isForeign && getT(m) > lastReadT){
      if (chatCollapsed) state.unreadCount += 1;
      lastReadT = getT(m);
      state.lastReadTs = lastReadT;
      updateUnreadBadge();
      playNotificationSound();
      vibrate();
    }

    // —Ä–µ–Ω–¥–µ—Ä
    const stickSite = nearBottom(chatListSite);
    const stickOv   = nearBottom(chatListOverlay);
    renderChat(msgs);
    if (stickSite) chatListSite.scrollTop = chatListSite.scrollHeight;
    if (stickOv)   chatListOverlay.scrollTop = chatListOverlay.scrollHeight;

    // –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à (–±–µ–∑ —Å–º–µ—à–∏–≤–∞–Ω–∏—è —Å —É–¥–∞–ª—ë–Ω–Ω—ã–º–∏!)
    state.localChat = msgs.slice(-100);
    localStorage.setItem('cc_chat_cache', JSON.stringify(state.localChat));
  });
  
  // –°–ª—É—à–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
  onChildRemoved(q, (snap)=>{
    const removedKey = snap.key;
    const index = msgs.findIndex(m => m.key === removedKey);
    if (index >= 0) {
      msgs.splice(index, 1);
      renderChat(msgs);
      state.localChat = msgs.slice(-100);
      localStorage.setItem('cc_chat_cache', JSON.stringify(state.localChat));
    }
  });
})();

function nearBottom(el, pad=60){
  return el.scrollHeight - el.scrollTop - el.clientHeight < pad;
}


  /* ======= REACTIONS ======= */
// –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π serverTimestamp –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ –∏–º–ø–æ—Ä—Ç–æ–≤
// ... limitToLast, onChildAdded, serverTimestamp } from ".../firebase-database.js";


let _lastReactionAt = 0;

async function sendReaction(reaction) {
  try {
    // 0) –¥–æ—Å—Ç—É–ø –µ—Å—Ç—å?
    if (!auth?.currentUser) {
      console.warn('[rx] blocked: no auth');
      return;
    }

    // 1) –∞–Ω—Ç–∏—Å–ø–∞–º
    const now = Date.now();
    if (now - _lastReactionAt < 350) {
      console.log('[rx] throttled');
      return;
    }
    _lastReactionAt = now;

    // 2) –¥–∞–Ω–Ω—ã–µ –ø–æ–¥ –ø—Ä–∞–≤–∏–ª–∞
    const color = (state?.color && String(state.color).trim()) || '#16c7b7';
    const item = {
      uid: auth.currentUser.uid,
      color,                 // –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –Ω–µ –ø—É—Å—Ç–æ–π
      t: serverTimestamp(),  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
      id: crypto.randomUUID()
    };

    // –ï—Å–ª–∏ —Ä–µ–∞–∫—Ü–∏—è - PNG (–æ–±—ä–µ–∫—Ç)
    if (typeof reaction === 'object' && reaction.type === 'png') {
      item.type = 'png';
      item.src = reaction.src; // –ü—É—Ç—å –∫ PNG
      item.key = reaction.key; // –ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    } else {
      // –û–±—ã—á–Ω–∞—è —ç–º–æ–¥–∑–∏ (—Å—Ç—Ä–æ–∫–∞)
      item.emoji = reaction;
      item.emo = reaction; // –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    }

    // 3) –ø—É—à –≤ –Ω–æ–≤—ã–π –∫–ª—é—á
    const db = getDatabase();
    const key = push(reactsRoot).key;
    console.log('[rx] push', key, item);
    await update(child(reactsRoot, key), item);

    console.log('[rx] ok', key);
  } catch (e) {
    console.error('Failed to send reaction to Firebase:', e);
  }
}

// === REACTIONS ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å—Ç—Ä–∏–º + –ª–æ–≥–∏ ===
if (!window.__reactionsBound) {
  window.__reactionsBound = true;

  console.log('[rx] binding reactions stream on', `${basePath}/reactions`);

  // A) —Ç–æ—á–µ—á–Ω—ã–π –ø–æ—Ç–æ–∫ onChildAdded ‚Äî –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π push –ø–æ –æ–¥–Ω–æ–º—É
  // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
  const startTime = Date.now();
  const tailSize = 10; // –ò–ª–∏ —Ç–≤–æ–π –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –¥—Ä—É–≥–æ–µ
  const qA = query(reactsRoot, orderByChild('t'), limitToLast(tailSize));
  onChildAdded(qA, (snapshot) => {
    const it = snapshot.val();
    const key = snapshot.key;
    console.log('[rx] childAdded', key, JSON.stringify(it)); // –î–µ–±–∞–≥ —Å –ø–æ–ª–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º

    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ (–¥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
    if (it.t < startTime - 1000) {
      console.log('[rx] skipped old reaction', key);
      return;
    }

    const isOurReaction = (it.uid === (auth.currentUser?.uid || state.id));
    const shouldShow = isOverlayMode() || !isOurReaction;
    if (shouldShow && typeof spawnEmoji === 'function') {
      spawnEmoji(it);
    }
  });

  // B) –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: —Ä–∞–∑–º–µ—Ä —Ö–≤–æ—Å—Ç–∞ (–≤–∏–¥–∏–º, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ —Ä–µ–∞–ª—å–Ω–æ –∂–∏–≤—ë—Ç)
  const qB = query(reactsRoot, orderByChild('t'), limitToLast(5));
  onValue(qB, (snap) => {
    let cnt = 0; snap.forEach(()=>cnt++);
    console.log('[rx] tail size', cnt);
  });
}


  /* ======= AUTH GATE + –ê–í–¢–û–õ–û–ì–ò–ù ======= */
  function setBlur(on){ document.querySelector('.app').classList.toggle('blur-wrap', on); }
  function isOverlayMode(){ return (localStorage.getItem('cc_mode')||'watch')==='overlay'; }

  // –ê–í–¢–û–õ–û–ì–ò–ù –î–õ–Ø OVERLAY –†–ï–ñ–ò–ú–ê
  const AUTO_LOGIN_NAME = '–õ—ë—Ö–∞';
  const AUTO_LOGIN_COLOR = '#1e40af'; // –Ω–∞—Å—ã—â–µ–Ω–Ω–æ —Å–∏–Ω–∏–π
  const AUTO_LOGIN_PIN = '1111';

  gateEnter.addEventListener('click', doGateLogin);
  gatePin.addEventListener('keydown', e=>{ if(e.key==='Enter') doGateLogin(); });

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞
  function checkAutoLogin() {
    const savedName = localStorage.getItem('cc_name');
    const isAuth = localStorage.getItem('cc_auth') === 'true';

    // –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–∂–∞–ª "–í—ã–π—Ç–∏", cc_auth –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω, –∏ –º—ã –ø—Ä–æ—Å—Ç–æ —Å—Ç–æ–∏–º –Ω–∞ –º–µ—Å—Ç–µ
    if (!isAuth || !savedName) {
      console.log('No active session found.');
      gate.classList.remove('hidden');
      setBlur(true);
      return; 
    }

    // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –µ—Å—Ç—å - –∑–∞—Ö–æ–¥–∏–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    gate.classList.add('hidden'); 
    setBlur(false);
    
    state.name = savedName;
    state.color = localStorage.getItem('cc_color') || '#16c7b7';
    
    setTimeout(() => {
      // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ü–ò–ù —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
      gatePin.value = '1111'; 
      doGateLogin();
    }, 10);
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ä–∞–∑—É
  checkAutoLogin();

  async function doGateLogin() {
    const pin = gatePin.value.trim();
    const inputName = document.getElementById('gateName').value.trim() || '–ß—É–∂–æ–π';
    const inputColor = gateColor.value;

    if (pin !== '1111') {
      gateHint.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù';
      gateHint.classList.add('show');
      gatePin.classList.add('error');
      gateCard.classList.remove('error');
      requestAnimationFrame(() => gateCard.classList.add('error'));
      gatePin.select();
      return;
    }

    // –ë—ã—Å—Ç—Ä–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–µ—Å–ª–∏ –±–∞–Ω —É–∂–µ –±—ã–ª –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏)
    if (localStorage.getItem('cc_banned') === 'true') {
      document.body.innerHTML = '<h1 style="color:white; text-align:center; margin-top:20%;">‚ö∞Ô∏è –¢–´ –ú–ï–†–¢–í –ò –ò–ó–ì–ù–ê–ù ‚ö∞Ô∏è</h1>';
      return;
    }

    try {
      console.log("LOG: –ù–∞—á–∏–Ω–∞–µ–º –≤—Ö–æ–¥...");

      // 1. –°–ù–ê–ß–ê–õ–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
      // –¢–µ–ø–µ—Ä—å –±–∞–∑–∞ –±—É–¥–µ—Ç –∑–Ω–∞—Ç—å, —á—Ç–æ –º—ã "—Å–≤–æ–∏", –∏ –¥–∞—Å—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–Ω–æ–≤
      await signInAnonymously(auth);
      const uid = auth.currentUser.uid;
      console.log("LOG: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, UID:", uid);

      // 2. –ü–û–õ–£–ß–ê–ï–ú IP
      let userIP = null;
      try {
        const ipRes = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipRes.json();
        userIP = ipData.ip;
        console.log("LOG: –í–∞—à IP:", userIP);
      } catch (e) { console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP"); }

      // 3. –ü–†–û–í–ï–†–ö–ê –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ë–ê–ù–ê –ü–û IP
      if (userIP) {
        const ipKey = userIP.replaceAll('.', '_');
        // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±–∞–Ω. –¢–µ–ø–µ—Ä—å Permission Denied –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ!
        const banRef = ref(db, `${basePath}/banned_ips/${ipKey}`);
        const banSnap = await get(banRef);
        
        if (banSnap.exists()) {
          const banData = banSnap.val();
          if (Date.now() < banData.bannedUntil) {
            localStorage.setItem('cc_banned', 'true');
            alert(`–í–ê–® IP –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù. ‚ö∞Ô∏è`);
            await signOut(auth); // –í—ã—Ö–æ–¥–∏–º, —Ä–∞–∑ –±–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
            location.reload();
            return;
          }
        }
      }

      // 4. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–†–û–§–ò–õ–Ø
      const userRef = ref(db, `${basePath}/users/${uid}`);
      const userSnap = await get(userRef);
      const userData = userSnap.val();

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      if (userData) {
        state.name = (inputName !== '–ß—É–∂–æ–π') ? inputName : (userData.name || '–ß—É–∂–æ–π');
        state.createdAt = userData.createdAt;
        state.activity = userData.activity || {};
        state.color = userData.color || inputColor;
      } else {
        state.name = inputName;
        state.color = inputColor;
        state.createdAt = Date.now();
        state.activity = {};
      }

      // 5. –ü–†–û–í–ï–†–ö–ê –ù–ê 4 –ß–ï–†–ï–ü–ê (–°–ú–ï–†–¢–¨)
      if (typeof getSkullLevel === 'function' && getSkullLevel(state) >= 4) {
        localStorage.setItem('cc_banned', 'true');
        
        if (userIP) {
          const ipKey = userIP.replaceAll('.', '_');
          await set(ref(db, `${basePath}/banned_ips/${ipKey}`), {
            uid: uid,
            name: state.name,
            bannedAt: serverTimestamp(),
            bannedUntil: Date.now() + (7 * 24 * 60 * 60 * 1000)
          });
        }
        
        alert("–¢–´ –ú–ï–†–¢–í. –í—Ö–æ–¥ –≤–æ—Å–ø—Ä–µ—â–µ–Ω. ‚ö∞Ô∏è");
        await signOut(auth);
        location.reload();
        return;
      }

      // 6. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–ó–´
      const now = new Date();
      const dateKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      
      const updates = {
        lastSeen: serverTimestamp(),
        lastIP: userIP || 'unknown',
        name: state.name,
        color: state.color,
        [`activity/${dateKey}`]: serverTimestamp()
      };
      if (!userData || !userData.createdAt) updates.createdAt = serverTimestamp();

      await update(userRef, updates);

      // 7. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø
      saveState();
      state.authed = true;
      gate.classList.add('hidden');
      setBlur(false);

      if (window.$statusText) $statusText.textContent = '–û–Ω–ª–∞–π–Ω';
      console.log("FINAL STATE CHECK:", state.name);

      if (typeof initVideo === 'function') initVideo();
      if (typeof heartbeat === 'function') heartbeat();

    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', e);
      // –ï—Å–ª–∏ –≤—Å—ë –µ—â–µ –ø–∏—à–µ—Ç Permission Denied, –∑–Ω–∞—á–∏—Ç –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase
      if (e.message.toLowerCase().includes('permission denied')) {
        alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ. –ü—Ä–æ–≤–µ—Ä—å Rules –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase.");
      } else {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
      }
    }
  }



  // LOGOUT
  logoutBtn.addEventListener('click', async ()=>{
    console.log('Logging out and clearing session...');
    try { await signOut(auth); } catch(e) {}

    // –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê: —É–¥–∞–ª—è–µ–º –≤—Å—ë, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
    localStorage.removeItem('cc_auth');
    localStorage.removeItem('cc_name');
    localStorage.removeItem('cc_color');

    state.authed = false;
    state.name = '';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –ø—É—Å—Ç—ã–º–∏
    document.getElementById('gateName').value = '';
    gatePin.value = '';
    gateColor.value = '#16c7b7';

    $statusText.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω';
    $dotAuth.classList.remove('ok');
    $dotAuth.classList.add('warn');

    gate.classList.remove('hidden'); 
    setBlur(true);
  });

  // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—Å—ë —Ä–∞–∑–º—ã—Ç–æ
  setBlur(true);

  function initVideo(){
    const url = new URL(FIXED_VIEW);
    if(!url.searchParams.get('cleanoutput')) url.searchParams.set('cleanoutput','1');
    if(!url.searchParams.get('stats')) url.searchParams.set('stats','0');
    if (!isOverlayMode()) $player.src = url.toString();
    else $player.classList.add('hidden');
  }
  $statusText.textContent='–û—Ñ—Ñ–ª–∞–π–Ω'; $dotAuth.classList.add('warn');

  onAuthStateChanged(auth, (user)=>{
    if (user) { state.authed = true; $dotAuth.classList.remove('warn'); $dotAuth.classList.add('ok'); $statusText.textContent='–û–Ω–ª–∞–π–Ω'; heartbeat(); }
    else { state.authed = false; $dotAuth.classList.remove('ok'); $dotAuth.classList.add('warn'); $statusText.textContent='–û—Ñ—Ñ–ª–∞–π–Ω'; }
  });

  /* ======= TOOLS ======= */
  function updateToolDisplay() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    if (state.tool === 'vote') {
      // –†–µ–∂–∏–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
      toolToggle.textContent = '–†–∏—Å–æ–≤–∞—Ç—å';
      toolToggle.classList.remove('btn');
      toolToggle.classList.add('btn', 'ghost', 'small');
      
      toolErase.classList.remove('btn');
      toolErase.classList.add('btn', 'ghost', 'small');
    } else if (state.tool === 'draw') {
      // –†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è
      toolToggle.textContent = '–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å';
      toolToggle.classList.remove('ghost');
      toolToggle.classList.add('btn', 'small');
      
      toolErase.classList.remove('btn');
      toolErase.classList.add('btn', 'ghost', 'small');
    } else if (state.tool === 'erase') {
      // –†–µ–∂–∏–º –ª–∞—Å—Ç–∏–∫–∞
      toolToggle.textContent = '–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å';
      toolToggle.classList.remove('btn');
      toolToggle.classList.add('btn', 'ghost', 'small');
      
      toolErase.classList.remove('ghost');
      toolErase.classList.add('btn', 'small');
    }
  }
  
  function setTool(t){
    state.tool=t; saveState();
    updateToolDisplay();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä –∏ –¥–∏–∞–ø–∞–∑–æ–Ω –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    if (t === 'draw') {
      brushSizeSlider.min = MIN_WIDTH;
      brushSizeSlider.max = MAX_PEN_WIDTH;
      brushSizeSlider.value = PEN_WIDTH;
      brushSizeValue.textContent = PEN_WIDTH + 'px';
    } else if (t === 'erase') {
      brushSizeSlider.min = MIN_WIDTH;
      brushSizeSlider.max = MAX_ERASE_WIDTH;
      brushSizeSlider.value = ERASE_WIDTH;
      brushSizeValue.textContent = ERASE_WIDTH + 'px';
    }
  }
  toolToggle.addEventListener('click', ()=>{
    if (state.tool==='vote') {
      setTool('draw');
    } else {
      setTool('vote');
    }
  });
  toolErase.addEventListener('click', ()=> {
    if (state.tool === 'erase') {
      // –ï—Å–ª–∏ –ª–∞—Å—Ç–∏–∫ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ä–∏—Å–æ–≤–∞–Ω–∏—é
      setTool('draw');
    } else {
      // –ò–Ω–∞—á–µ –≤–∫–ª—é—á–∞–µ–º –ª–∞—Å—Ç–∏–∫
      setTool('erase');
    }
  });
  toolClear.addEventListener('click', async ()=>{
    if (!auth.currentUser) return;
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ä–∏—Å—É–Ω–∫–∏?')) await remove(strokesRoot);
  });

  /* ======= ADMIN CONTROLS (FOOTER) ======= */

  // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –≥–æ–ª–æ—Å–∞"
  if (btnDeleteVotes) {
    btnDeleteVotes.addEventListener('click', async ()=>{
      if (!auth.currentUser) { alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
      const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤:');
      if (password !== '0000') { if (password !== null) alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'); return; }
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –≥–æ–ª–æ—Å–∞?')) return;
      try {
        await remove(pointsRoot);
        state.points.clear();
        alert('–í—Å–µ –≥–æ–ª–æ—Å–∞ —É–¥–∞–ª–µ–Ω—ã');
      } catch(e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥–æ–ª–æ—Å–æ–≤');
      }
    });
  }

  /* ======= CHAT UI ======= */
  let chatCollapsed=false;
  
  // –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø—Ä–æ—Å—Ç–æ–π beep)
  function playNotificationSound(){
    if (!state.notifications) return;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
    oscillator.start(audioCtx.currentTime);
    oscillator.stop(audioCtx.currentTime + 0.2);
  }
  
  // –í–∏–±—Ä–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
  function vibrate(){
    if (!state.notifications) return;
    if (navigator.vibrate) navigator.vibrate(200);
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
  function updateUnreadBadge(){
    if (state.unreadCount > 0 && chatCollapsed){
      chatBadge.textContent = state.unreadCount > 99 ? '99+' : state.unreadCount;
      chatBadge.classList.remove('hidden');
    } else {
      chatBadge.classList.add('hidden');
    }
  }
  
  // –ö–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  chatNotifications.addEventListener('click', ()=>{
    state.notifications = !state.notifications;
    localStorage.setItem('cc_notifications', state.notifications);
    chatNotifications.textContent = state.notifications ? 'üîî' : 'üîï';
    chatNotifications.style.opacity = state.notifications ? '1' : '0.5';
  });
  // –£—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  chatNotifications.textContent = state.notifications ? 'üîî' : 'üîï';
  chatNotifications.style.opacity = state.notifications ? '1' : '0.5';
  
  chatToggle.addEventListener('click', ()=>{
    chatCollapsed=!chatCollapsed;
    chatToggle.textContent = chatCollapsed? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å' : '–°–≤–µ—Ä–Ω—É—Ç—å';
    chatPanel.querySelector('.chat-body').classList.toggle('chat-hidden', chatCollapsed);
    chatPanel.querySelector('.chat-input').classList.toggle('chat-hidden', chatCollapsed);
    
    // –ü—Ä–∏ —Å–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–∏ —É–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–æ –¢–û–õ–¨–ö–û —à–∞–ø–∫–∏
    if (chatCollapsed) {
      chatPanel.style.maxHeight = 'fit-content';
      chatPanel.style.height = 'auto';
      chatPanel.style.overflow = 'hidden';
      chatPanel.style.minHeight = 'auto'; // –£–±–∏—Ä–∞–µ–º min-height
      chatPanel.style.resize = 'none'; // –û—Ç–∫–ª—é—á–∞–µ–º resize –≤ —Å–≤—ë—Ä–Ω—É—Ç–æ–º –≤–∏–¥–µ
    } else {
      chatPanel.style.maxHeight = '65vh';
      chatPanel.style.height = '';
      chatPanel.style.overflow = '';
      chatPanel.style.minHeight = '200px'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º min-height
      chatPanel.style.resize = 'both'; // –í–∫–ª—é—á–∞–µ–º resize –æ–±—Ä–∞—Ç–Ω–æ
    }
    
    // –ü—Ä–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫// –ü—Ä–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
    if (!chatCollapsed){
      state.unreadCount = 0;
      state.lastReadTs = Date.now();
      updateUnreadBadge();
    }
  });

  chatSend.addEventListener('click', sendChat);
  chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });
  
  // Overlay-—á–∞—Ç (—Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è)
  chatSendOverlay.addEventListener('click', sendChatOverlay);
  chatInputOverlay.addEventListener('keydown', e=>{ if(e.key==='Enter') sendChatOverlay(); });
// ===== –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —á–∞—Ç (—Å–∞–π—Ç) =====
async function sendChat(){
  if (!state.authed) return;
  const txt = chatInput.value.trim(); 
  if (!txt) return;

  // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  if (editingMessage) {
    await saveEditedMessage(txt);
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É /rat
  if (txt === '/rat') {
    chatInput.value = '';
    await toggleRatMode();
    return;
  }

  // --- –í–ù–£–¢–†–ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê –û–¢–ü–†–ê–í–ö–ò –°–û–û–ë–©–ï–ù–ò–Ø ---

  // 1. –ö–æ–º–∞–Ω–¥–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è: /id_—Å—Ç–∞—Ä—ã–π+id_–Ω–æ–≤—ã–π
  // –ö–æ–º–∞–Ω–¥–∞ —Å–ª–∏—è–Ω–∏—è: /ID1 + ID2
  if (txt.startsWith('/') && txt.includes(' + ')) {
      // –£–±–∏—Ä–∞–µ–º —Å–ª—ç—à –∏ —Ä–∞–∑–±–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ –ø–ª—é—Å—É
      const cleanTxt = txt.substring(1); 
      const [oldId, newId] = cleanTxt.split('+').map(s => s.trim());

          // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å—Ä–∞–∑—É
          if (typeof chatInput !== 'undefined') chatInput.value = '';
          
          console.log(`LOG: –ü–æ–ø—ã—Ç–∫–∞ —Å–ª–∏—è–Ω–∏—è ${oldId} -> ${newId}`);

          const oldRef = ref(db, `${basePath}/users/${oldId}`);
          const newRef = ref(db, `${basePath}/users/${newId}`);

          get(oldRef).then(async (oldSnap) => {
              const newSnap = await get(newRef);

              if (oldSnap.exists() && newSnap.exists()) {
                  const oldData = oldSnap.val();
                  const newData = newSnap.val();

                  // 1. –û–±—ä–µ–¥–∏–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–≤—Å–µ —Å—É–±–±–æ—Ç—ã)
                  const mergedActivity = { 
                      ...(oldData.activity || {}), 
                      ...(newData.activity || {}) 
                  };

                  // 2. –ë–µ—Ä–µ–º —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –¥–∞—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                  const earliestCreated = Math.min(
                      oldData.createdAt || Date.now(), 
                      newData.createdAt || Date.now()
                  );

                  // 3. –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
                  await update(newRef, {
                      activity: mergedActivity,
                      createdAt: earliestCreated,
                      mergedFrom: oldId
                  });

                  // 4. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∞–∫–∫–∞—É–Ω—Ç
                  await remove(oldRef);

                  alert(`–°–ª–∏—è–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –î–∞–Ω–Ω—ã–µ –∏–∑ ${oldId} –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ ${newId}. –°—Ç–∞—Ä—ã–π –∞–∫–∫ —É–¥–∞–ª–µ–Ω.`);
                  console.log("LOG: –°–ª–∏—è–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ.");
              } else {
                  alert("–û—à–∏–±–∫–∞: –û–¥–∏–Ω –∏–∑ ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è.");
              }
          }).catch(e => {
              console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏:", e);
              alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å.");
          });

      
      return; // –ß—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–ª–µ—Ç–µ–ª–æ –≤ —á–∞—Ç
  }  
  if
    // 3. –ù–∞—Å–∏–ª—å–Ω–∞—è —Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏: /id rename –ù–æ–≤–æ–µ–ò–º—è
  if (txt.startsWith('/') && txt.includes(' rename ')) {
      chatInputOverlay.value = '';
      const parts = txt.replace('/', '').split(' rename ');
      const targetId = parts[0].trim();
      const newName = parts[1] ? parts[1].trim() : '';
  
      if (!targetId || !newName) {
        console.log('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: /id rename –ù–æ–≤–æ–µ–ò–º—è');
        return;
      }
  
      // –ú–µ–Ω—è–µ–º –≤ users
      const userRef = ref(db, `${basePath}/users/${targetId}`);
      await update(userRef, { name: newName });
      console.log(`–ò–º—è –≤ users/${targetId} ‚Üí ${newName}`);
  
      // –ú–µ–Ω—è–µ–º –≤ presence
      const presenceRef = ref(db, `${basePath}/presence/${targetId}`);
      await update(presenceRef, { 
        name: newName,
        ts: Date.now()  // —á—Ç–æ–±—ã presence –Ω–µ "—É–º–µ—Ä"
      });
      console.log(`–ò–º—è –≤ presence/${targetId} ‚Üí ${newName}`);
  
      // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–∂–Ω–æ –µ—â—ë –æ–±–Ω–æ–≤–∏—Ç—å points (–≥–æ–ª–æ—Å–∞), –Ω–æ –æ–Ω–∏ –ø–æ uid, –∏–º—è —Ç–∞–º –±–µ—Ä—ë—Ç—Å—è –∏–∑ presence/users
      // await update(ref(db, `${basePath}/points/${targetId}`), { name: newName });
  
    return;
  }
// 2. –ö–æ–º–∞–Ω–¥–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—á–µ—Ä–µ–ø–Ω–µ–Ω–∏—è —Å IP-–±–∞–Ω–æ–º: /id skull
  if (txt.startsWith('/') && txt.endsWith(' skull')) {
    chatInputOverlay.value = '';
    const targetId = txt.replace('/', '').replace(' skull', '').trim();
    
    if (targetId) {
      const userRef = ref(db, `${basePath}/users/${targetId}`);
      const snap = await get(userRef);
      
      if (!snap.exists()) {
        console.error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ");
        return;
      }

      const data = snap.val();
      const activity = data.activity || {};
      let currentCreatedAt = data.createdAt || Date.now();

      let d = new Date();
      // 1. –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –ø—Ä–æ—à–µ–¥—à—É—é (–∏–ª–∏ —Ç–µ–∫—É—â—É—é) —Å—É–±–±–æ—Ç—É
      while (d.getDay() !== 6) { d.setDate(d.getDate() - 1); }

      // 2. –ò—â–µ–º –ø–µ—Ä–≤—É—é —Å—É–±–±–æ—Ç—É –≤ –ø—Ä–æ—à–ª–æ–º, –∫–æ—Ç–æ—Ä–∞—è –µ—â–µ –ù–ï —è–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–ø–æ–º
      let found = false;
      for (let i = 0; i < 52; i++) {
        const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        
        // –°—á–∏—Ç–∞–µ–º —Å—É–±–±–æ—Ç—É "—á–∏—Å—Ç–æ–π", –µ—Å–ª–∏ –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±—ã–ª–∞ –ø–æ–∑–∂–µ –Ω–µ—ë 
        // –ò–õ–ò –µ—Å–ª–∏ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –µ—Å—Ç—å –æ—Ç–º–µ—Ç–∫–∞ –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        const isAlreadySkull = (currentCreatedAt <= d.getTime()) && !activity[dateKey];

        if (!isAlreadySkull) {
          const updates = {};
          
          // –£–¥–∞–ª—è–µ–º –æ—Ç–º–µ—Ç–∫—É –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏
          updates[`activity/${dateKey}`] = null; 
          
          // –ü–æ–¥–≤–∏–≥–∞–µ–º –¥–∞—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã —Å—É–±–±–æ—Ç–∞ –ø–æ–ø–∞–ª–∞ –≤ –æ—Ç—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥
          if (currentCreatedAt > d.getTime()) {
            updates[`createdAt`] = d.getTime() - (24 * 60 * 60 * 1000);
            currentCreatedAt = updates[`createdAt`]; // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∏–∂–µ
          }
          
          // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          await update(userRef, updates);
          console.log(`–î–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetId} –∑–∞ –¥–∞—Ç—É ${dateKey}`);
          
          // 3. –ü–†–û–í–ï–†–ö–ê –ù–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–†–û–í–ï–ù–¨ (–ë–ê–ù –ü–û IP)
          // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã –ø–æ—Å—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —á–µ—Ä–µ–ø–æ–≤
          const updatedState = {
            ...data,
            createdAt: currentCreatedAt,
            activity: { ...activity, [dateKey]: null }
          };

          const newLevel = typeof getSkullLevel === 'function' ? getSkullLevel(updatedState) : 0;
          
          if (newLevel >= 4) {
            console.log("–£–†–û–í–ï–ù–¨ 4 –î–û–°–¢–ò–ì–ù–£–¢. –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º IP-–±–∞–Ω...");
            
            // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å IP —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–∏ –≤—Ö–æ–¥–µ)
            if (data.lastIP && data.lastIP !== 'unknown') {
              const ipKey = data.lastIP.replaceAll('.', '_');
              await set(ref(db, `${basePath}/banned_ips/${ipKey}`), {
                uid: targetId,
                name: data.name || '–ß—É–∂–æ–π',
                bannedAt: serverTimestamp(),
                bannedUntil: Date.now() + (7 * 24 * 60 * 60 * 1000), // –ë–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é
                reason: "Executed by admin"
              });
              console.log(`IP ${data.lastIP} —É—Å–ø–µ—à–Ω–æ –∑–∞–±–∞–Ω–µ–Ω –≤ –±–∞–∑–µ.`);
            } else {
              console.warn("IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, –±–∞–Ω –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ ID.");
            }
          }

          found = true;
          break; 
        }
        d.setDate(d.getDate() - 7);
      }
      
      if (!found) console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–ø: –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∑–∞ –≥–æ–¥");
    }
    return;
  }

  // 3. –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–∏–ª–æ–≤–∞–Ω–∏—è: /–≤–µ—Ä–Ω—É—Ç—å id
  if (txt.startsWith('/–≤–µ—Ä–Ω—É—Ç—å ')) {
    chatInputOverlay.value = '';
    const targetId = txt.replace('/–≤–µ—Ä–Ω—É—Ç—å ', '').trim();
    
    if (targetId) {
      const userRef = ref(db, `${basePath}/users/${targetId}`);
      await update(userRef, {
        isForgiven: true, // –ù–∞—à–∞ —Ñ—É–Ω–∫—Ü–∏—è getDisplayName —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç –∏ —É–±–µ—Ä–µ—Ç —á–µ—Ä–µ–ø–∞
        createdAt: Date.now() // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—É–±–±–æ—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç
      });
      console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${targetId} –ø–æ–º–∏–ª–æ–≤–∞–Ω`);
    }
    return;
  }

  // –°–û–û–ë–©–ï–ù–ò–ï –¢–û–õ–¨–ö–û –ù–ê –°–ï–†–í–ï–†–ù–û–ú –í–†–ï–ú–ï–ù–ò
  const msg = {
    uid: auth.currentUser?.uid || state.id,
    name: getDisplayName(state), // –í–æ—Ç –∑–¥–µ—Å—å –º–∞–≥–∏—è! || '–ß—É–∂–æ–π',
    color: state.color,
    text: txt,
    t: serverTimestamp()        // <-- –≥–ª–∞–≤–Ω–æ–µ: —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ç–∞–π–º—Å—Ç–µ–º–ø
  };
  
  // –î–æ–±–∞–≤–ª—è–µ–º reply –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ
  if (replyToMessage) {
    msg.replyTo = replyToMessage.key;
    cancelReply();
  }

  chatInput.value = '';
  try{
    const key = push(chatRoot).key;
    await update(ref(db, `${basePath}/chat/${key}`), msg);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º RAT —Ä–µ–∂–∏–º –∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
    const ratSnapshot = await get(ratModeRef);
    const ratActive = ratSnapshot.exists() && ratSnapshot.val().active;
    if (ratActive) {
      scheduleMessageDeletion(key, 5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç
    }
  }catch(e){
    console.error('‚ùå chat write failed', e);
    // –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç –≤ input, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å
  }
}

// ===== –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —á–∞—Ç (–æ–≤–µ—Ä–ª–µ–π) =====
async function sendChatOverlay(){
  if (!state.authed) return;
  const txt = chatInputOverlay.value.trim(); 
  if (!txt) return;

  // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  if (editingMessage) {
    await saveEditedMessage(txt);
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É /rat
  if (txt === '/rat') {
    chatInputOverlay.value = '';
    await toggleRatMode();
    return;
  }

  const msg = {
    uid: auth.currentUser?.uid || state.id,
    name: getDisplayName(state) || '–ß—É–∂–æ–π',
    color: state.color,
    text: txt,
    t: serverTimestamp()
  };
  
  // –î–æ–±–∞–≤–ª—è–µ–º reply –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ
  if (replyToMessage) {
    msg.replyTo = replyToMessage.key;
    cancelReply();
  }

  chatInputOverlay.value = '';
  try{
    const key = push(chatRoot).key;
    await update(ref(db, `${basePath}/chat/${key}`), msg);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º RAT —Ä–µ–∂–∏–º –∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
    const ratSnapshot = await get(ratModeRef);
    const ratActive = ratSnapshot.exists() && ratSnapshot.val().active;
    if (ratActive) {
      scheduleMessageDeletion(key, 5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç
    }
  }catch(e){
    console.error('‚ùå chat write failed (overlay)', e);
  }
}

  // Overlay chat auto show/hide
  let overlayHideTimer=null;
  function showOverlayChatTemporarily(){
    if (!isOverlayMode()) return;
    chatOverlay.classList.add('show');
    clearTimeout(overlayHideTimer);
    overlayHideTimer=setTimeout(()=> chatOverlay.classList.remove('show'), 15000);
  }
  // –ß–∞—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ Python –æ–≤–µ—Ä–ª–µ–π (Alt+F7)
  // Alt+~ —É–±—Ä–∞–ª–∏, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏

  // Persist overlay chat size (width/height)
  (function(){
    const keyW = 'overlay_chat_w', keyH = 'overlay_chat_h';
    function ensureDefaultChatHeight(){ if(!chatOverlay.style.height){ chatOverlay.style.height = '360px'; }}
    const savedW = localStorage.getItem(keyW), savedH = localStorage.getItem(keyH);
    if (savedW) chatOverlay.style.width = savedW;
    if (savedH) chatOverlay.style.height = savedH;
    ensureDefaultChatHeight();
    let saveTimer=null;
    const saveSize = ()=>{
      clearTimeout(saveTimer);
      saveTimer=setTimeout(()=>{
        localStorage.setItem(keyW, chatOverlay.style.width || chatOverlay.getBoundingClientRect().width+'px');
        localStorage.setItem(keyH, chatOverlay.style.height || chatOverlay.getBoundingClientRect().height+'px');
      }, 200);
    };
    // Save on mouseup (after resize) and on transition end
    chatOverlay.addEventListener('mouseup', saveSize);
    chatOverlay.addEventListener('mouseleave', saveSize);
    new MutationObserver(()=>saveSize()).observe(chatOverlay, { attributes:true, attributeFilter:['style']});
  })();


// ===== RAT –†–ï–ñ–ò–ú =====
// –§—É–Ω–∫—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è RAT —Ä–µ–∂–∏–º–∞
async function toggleRatMode() {
  try {
    const snapshot = await get(ratModeRef);
    const currentState = snapshot.exists() && snapshot.val().active;
    const newState = !currentState;
    
    await set(ratModeRef, {
      active: newState,
      changedAt: Date.now(),
      changedBy: auth.currentUser?.uid || state.id
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const statusMsg = newState ? 'üêÄ RAT —Ä–µ–∂–∏–º –í–ö–õ–Æ–ß–ï–ù' : '‚úÖ RAT —Ä–µ–∂–∏–º –í–´–ö–õ–Æ–ß–ï–ù';
    showRatNotification(statusMsg);
    console.log(statusMsg);
  } catch(e) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è RAT —Ä–µ–∂–∏–º–∞:', e);
    showRatNotification('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è RAT —Ä–µ–∂–∏–º–∞');
  }
}

// –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
function scheduleMessageDeletion(messageKey, delayMs) {
  setTimeout(async () => {
    try {
      const msgRef = ref(db, `${basePath}/chat/${messageKey}`);
      await remove(msgRef);
      console.log(`üóëÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ ${messageKey} —É–¥–∞–ª–µ–Ω–æ (RAT —Ä–µ–∂–∏–º)`);
    } catch(e) {
      console.error(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è ${messageKey}:`, e);
    }
  }, delayMs);
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ RAT —Ä–µ–∂–∏–º–µ
function showRatNotification(message) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(185, 28, 28, 0.95));
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    z-index: 10001;
    font-weight: 700;
    font-size: 0.95em;
    animation: ratSlideIn 0.3s ease;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'ratSlideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ RAT —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const ratAnimStyle = document.createElement('style');
ratAnimStyle.textContent = `
  @keyframes ratSlideIn {
    from {
      opacity: 0;
      transform: translate(-50%, -20px);
    }
    to {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  }
  
  @keyframes ratSlideOut {
    from {
      opacity: 1;
      transform: translate(-50%, 0);
    }
    to {
      opacity: 0;
      transform: translate(-50%, -20px);
    }
  }
`;
document.head.appendChild(ratAnimStyle);


  // Bridge for system hotkeys from overlay app
  window.overlayHotkey = (i)=>{
    try{
      const btns = reactionsBar?.querySelectorAll('button');
      const b = btns && btns[i];
      if (!b) return;
      b.classList.add('reaction-clicked');
      setTimeout(()=> b.classList.remove('reaction-clicked'), 300);
      sendReaction(b.dataset.emo||b.textContent);
    }catch(e){ console.warn('overlayHotkey error', e); }
  };
  
  // –ó–ê–ö–†–´–¢–ò–ï –û–í–ï–†–õ–ï–Ø: Escape –≤ overlay —Ä–µ–∂–∏–º–µ
  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Escape' && isOverlayMode()){
      // –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º Python –æ–≤–µ—Ä–ª–µ–π –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
      if (confirm('–ó–∞–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π?')) {
        window.close(); // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
      }
      e.preventDefault();
    }
  });

  function renderChat(msgs){
    chatListSite.innerHTML=''; chatListOverlay.innerHTML='';
    for (const m of msgs){
      const currentUserId = auth.currentUser?.uid || state.id;
      const isOwnMessage = m.uid === currentUserId;
      
      // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–∞–π—Ç–∞
      const elSite = document.createElement('div'); 
      elSite.className='chat-msg' + (isOwnMessage ? ' own-message' : '');
      elSite.dataset.msgKey = m.key;
      elSite.dataset.msgUid = m.uid;
      elSite.dataset.msgTimestamp = m.t || m.ts || 0;
      
      // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ–≤–µ—Ä–ª–µ—è
      const elOverlay = document.createElement('div'); 
      elOverlay.className='chat-msg' + (isOwnMessage ? ' own-message' : '');
      elOverlay.dataset.msgKey = m.key;
      elOverlay.dataset.msgUid = m.uid;
      elOverlay.dataset.msgTimestamp = m.t || m.ts || 0;
      
      let html = '';
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å reply - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
      if (m.replyTo) {
        const replyMsg = msgs.find(msg => msg.key === m.replyTo);
        if (replyMsg) {
          const replyName = escapeHtml(replyMsg.name || '–ß—É–∂–æ–π');
          const replyText = escapeHtml((replyMsg.text || '').substring(0, 50));
          html += `<div class="chat-msg-reply-preview" data-reply-to="${m.replyTo}">
            <b style="color:${replyMsg.color||'#ccc'}">${replyName}</b>: ${replyText}${(replyMsg.text||'').length > 50 ? '...' : ''}
          </div>`;
        }
      }
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–º–µ–Ω–µ–º
      const name = escapeHtml(m.name||'–ß—É–∂–æ–π');
      const text = escapeHtml(m.text||'');
      const edited = m.edited ? '<span style="color:var(--muted);font-size:0.8em;margin-left:4px">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>' : '';
      
      html += `<div class="chat-msg-header">
        <b style="color:${m.color||'#ccc'}">${name}</b>
      </div>
      <div class="chat-msg-text">${text}${edited}</div>`;
      
      elSite.innerHTML = html;
      elOverlay.innerHTML = html;
      
      // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      setupMessageHandlers(elSite, m);
      setupMessageHandlers(elOverlay, m);
      
      chatListSite.appendChild(elSite);
      chatListOverlay.appendChild(elOverlay);
    }
    chatListSite.scrollTop = chatListSite.scrollHeight;
    chatListOverlay.scrollTop = chatListOverlay.scrollHeight;
  }
  
  function setupMessageHandlers(el, m) {
    let touchTimer = null;
    let touchStartTime = 0;
    
    // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ (–ü–ö) - —Å—Ä–∞–∑—É —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    el.addEventListener('dblclick', (e) => {
      e.preventDefault();
      setReplyTo(m);
      // –°—Ä–∞–∑—É —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      if (el.closest('#chatPanel')) {
        chatInput.focus();
      } else {
        chatInputOverlay.focus();
      }
    });
    
    // –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ (–ü–ö)
    el.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      showContextMenu(e, m);
    });
    
    // Touch events (–º–æ–±–∏–ª—å–Ω—ã–π)
    el.addEventListener('touchstart', (e) => {
      touchStartTime = Date.now();
      touchTimer = setTimeout(() => {
        // –£–¥–µ—Ä–∂–∞–Ω–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        showContextMenu(e.touches[0], m);
        navigator.vibrate && navigator.vibrate(50);
      }, 500);
    });
    
    el.addEventListener('touchend', (e) => {
      clearTimeout(touchTimer);
      const touchDuration = Date.now() - touchStartTime;
      
      // –î–≤–æ–π–Ω–æ–π —Ç–∞–ø –∑–∞ –±—ã—Å—Ç—Ä–æ–µ –≤—Ä–µ–º—è - –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç –∏ —Ñ–æ–∫—É—Å
      if (touchDuration < 300 && el._lastTouchEnd && (Date.now() - el._lastTouchEnd) < 300) {
        e.preventDefault();
        setReplyTo(m);
        // –°—Ä–∞–∑—É —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        if (el.closest('#chatPanel')) {
          chatInput.focus();
        } else {
          chatInputOverlay.focus();
        }
        el._lastTouchEnd = 0;
      } else {
        el._lastTouchEnd = Date.now();
      }
    });
    
    el.addEventListener('touchmove', () => {
      clearTimeout(touchTimer);
    });
    
    // –ö–ª–∏–∫ –ø–æ –ø—Ä–µ–≤—å—é —Ä–µ–ø–ª–∞—è - –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
    const replyPreview = el.querySelector('.chat-msg-reply-preview');
    if (replyPreview) {
      replyPreview.addEventListener('click', (e) => {
        e.stopPropagation();
        const targetKey = replyPreview.dataset.replyTo;
        const targetEl = document.querySelector(`[data-msg-key="${targetKey}"]`);
        if (targetEl) {
          targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          targetEl.style.background = 'rgba(22,199,183,0.3)';
          setTimeout(() => {
            targetEl.style.background = '';
          }, 1000);
        }
      });
    }
  }
  
  function setReplyTo(msg) {
    // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
    cancelEdit();
    
    replyToMessage = msg;
    
    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    document.querySelectorAll('.chat-msg.replying').forEach(el => {
      el.classList.remove('replying');
      const cancel = el.querySelector('.chat-msg-reply-cancel');
      if (cancel) cancel.remove();
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    const targetEls = document.querySelectorAll(`[data-msg-key="${msg.key}"]`);
    targetEls.forEach(el => {
      el.classList.add('replying');
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'chat-msg-reply-cancel';
      cancelBtn.textContent = '‚úï';
      cancelBtn.onclick = (e) => {
        e.stopPropagation();
        cancelReply();
      };
      el.appendChild(cancelBtn);
    });
    
    hideContextMenu();
  }
  
  function cancelReply() {
    replyToMessage = null;
    document.querySelectorAll('.chat-msg.replying').forEach(el => {
      el.classList.remove('replying');
      const cancel = el.querySelector('.chat-msg-reply-cancel');
      if (cancel) cancel.remove();
    });
  }
  
  function showContextMenu(e, msg) {
    const menu = chatContextMenu;
    menu.classList.add('show');
    
    const x = e.clientX || e.pageX;
    const y = e.clientY || e.pageY;
    
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—à–∏–º
    const currentUserId = auth.currentUser?.uid || state.id;
    const isOwnMessage = msg.uid === currentUserId;
    const messageTime = msg.t || msg.ts || 0;
    const timeSinceMessage = Date.now() - messageTime;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏
    const canEdit = isOwnMessage && timeSinceMessage <= 60 * 60 * 1000; // 1 —á–∞—Å
    const canDelete = isOwnMessage && timeSinceMessage <= 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç
    
    contextEdit.style.display = canEdit ? 'block' : 'none';
    contextDelete.style.display = canDelete ? 'block' : 'none';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    contextReply.onclick = () => {
      setReplyTo(msg);
    };
    
    contextEdit.onclick = () => {
      if (canEdit) startEditMessage(msg);
    };
    
    contextDelete.onclick = () => {
      if (canDelete) deleteMessage(msg);
    };
  }
  
  function hideContextMenu() {
    chatContextMenu.classList.remove('show');
  }
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  document.addEventListener('click', (e) => {
    if (!chatContextMenu.contains(e.target)) {
      hideContextMenu();
    }
  });
  
  // === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ===
  function startEditMessage(msg) {
    // –û—Ç–º–µ–Ω—è–µ–º reply –µ—Å–ª–∏ –±—ã–ª
    cancelReply();
    
    editingMessage = msg;
    
    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.querySelectorAll('.chat-msg-editing').forEach(el => {
      el.classList.remove('chat-msg-editing');
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    const targetEls = document.querySelectorAll(`[data-msg-key="${msg.key}"]`);
    targetEls.forEach(el => {
      el.classList.add('chat-msg-editing');
    });
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    chatInput.value = msg.text || '';
    chatInputOverlay.value = msg.text || '';
    
    // –§–æ–∫—É—Å–∏—Ä—É–µ–º –ø–æ–ª–µ
    chatInput.focus();
    chatInputOverlay.focus();
    
    hideContextMenu();
  }
  
  function cancelEdit() {
    if (!editingMessage) return;
    
    editingMessage = null;
    
    // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.querySelectorAll('.chat-msg-editing').forEach(el => {
      el.classList.remove('chat-msg-editing');
    });
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
    chatInput.value = '';
    chatInputOverlay.value = '';
  }
  
  async function saveEditedMessage(text) {
    if (!editingMessage || !auth.currentUser) return false;
    
    const currentUserId = auth.currentUser.uid || state.id;
    if (editingMessage.uid !== currentUserId) {
      alert('–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
      cancelEdit();
      return false;
    }
    
    const messageTime = editingMessage.t || editingMessage.ts || 0;
    const timeSinceMessage = Date.now() - messageTime;
    
    if (timeSinceMessage > 60 * 60 * 1000) {
      alert('–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –º–ª–∞–¥—à–µ 1 —á–∞—Å–∞');
      cancelEdit();
      return false;
    }
    
    try {
      const msgRef = ref(db, `${basePath}/chat/${editingMessage.key}`);
      await update(msgRef, {
        text: text,
        edited: true,
        editedAt: serverTimestamp()
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const index = msgs.findIndex(m => m.key === editingMessage.key);
      if (index >= 0) {
        msgs[index].text = text;
        msgs[index].edited = true;
        msgs[index].editedAt = Date.now();
        renderChat(msgs);
      }
      
      cancelEdit();
      return true;
    } catch (e) {
      console.error('Failed to edit message:', e);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
      return false;
    }
  }
  
  // === –£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ===
  async function deleteMessage(msg) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
    
    if (!auth.currentUser) return;
    
    const currentUserId = auth.currentUser.uid || state.id;
    if (msg.uid !== currentUserId) {
      alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
      return;
    }
    
    const messageTime = msg.t || msg.ts || 0;
    const timeSinceMessage = Date.now() - messageTime;
    
    if (timeSinceMessage > 30 * 60 * 1000) {
      alert('–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –º–ª–∞–¥—à–µ 30 –º–∏–Ω—É—Ç');
      return;
    }
    
    try {
      // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
      await remove(ref(db, `${basePath}/chat/${msg.key}`));
      
      // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ (–¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI)
      const index = msgs.findIndex(m => m.key === msg.key);
      if (index >= 0) {
        msgs.splice(index, 1);
        renderChat(msgs);
        state.localChat = msgs.slice(-100);
        localStorage.setItem('cc_chat_cache', JSON.stringify(state.localChat));
      }
      
      hideContextMenu();
    } catch (e) {
      console.error('Failed to delete message:', e);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
  }
  
  // –û—Ç–º–µ–Ω–∞ reply –∏ edit –ø—Ä–∏ Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (replyToMessage) {
        cancelReply();
        e.preventDefault();
      }
      if (editingMessage) {
        cancelEdit();
        e.preventDefault();
      }
    }
    
    // –ö–ª–∞–≤–∏—à–∞ –í–≤–µ—Ä—Ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–∞ –ü–ö)
    if (e.key === 'ArrowUp' && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey) {
      const activeEl = document.activeElement;
      // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —á–∞—Ç–∞ –∏ –æ–Ω–æ –ø—É—Å—Ç–æ–µ
      if ((activeEl === chatInput || activeEl === chatInputOverlay) && activeEl.value.trim() === '') {
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ
        const currentUserId = auth.currentUser?.uid || state.id;
        const myMessages = msgs.filter(m => m.uid === currentUserId);
        if (myMessages.length > 0) {
          const lastMsg = myMessages[myMessages.length - 1];
          const messageTime = lastMsg.t || lastMsg.ts || 0;
          const timeSinceMessage = Date.now() - messageTime;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–ª–∞–¥—à–µ 1 —á–∞—Å–∞
          if (timeSinceMessage <= 60 * 60 * 1000) {
            startEditMessage(lastMsg);
            e.preventDefault();
          }
        }
      }
    }
  });
  
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  
  function renderReactions(items){
    // –†–µ–∞–∫—Ü–∏–∏ –¢–û–õ–¨–ö–û –≤ –æ–≤–µ—Ä–ª–µ–µ!
    if (!isOverlayMode()) return;
    const now = Date.now();
    // –≠—Ç–æ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ onValue —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∞–∫—Ü–∏–µ–π
  }
  
  // –£–õ–£–ß–®–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è spawnEmoji: –û–î–ù–û —ç–º–æ–¥–∑–∏, —Å–ª—É—á–∞–π–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—è
function spawnEmoji(it){
  const layer = fxLayer || document.getElementById('fx-layer');
  if (!layer) { console.warn('spawnEmoji: fx-layer not found'); return; }

  const el = document.createElement('div');
  el.className = 'emoji stroke';

  // –¶–≤–µ—Ç–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  el.style.setProperty('--emoji-stroke', it.color || state.color || '#16c7b7');

  if (it.type === 'png' && it.src) {
    const img = document.createElement('img');
    img.src = it.src;
    img.alt = 'Reaction';
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'contain';
    el.appendChild(img);
    el.style.width = '256px'; // –ò–ª–∏ 512px, –µ—Å–ª–∏ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
    el.style.height = '256px';
  } else {
    // –û–±—ã—á–Ω–∞—è —ç–º–æ–¥–∑–∏
    const emo = (it.emoji ?? it.emo) || '‚ù§Ô∏è';
    el.textContent = emo;
    el.setAttribute('data-content', emo); // –î–ª—è ::before –≤ CSS
    el.style.fontSize = '40px'; // –ö–∞–∫ –±—ã–ª–æ
  }

  const w = layer.clientWidth || window.innerWidth;
  const h = layer.clientHeight || window.innerHeight;

  // –°–õ–£–ß–ê–ô–ù–´–ô –†–ê–ó–ú–ï–† (–æ—Ç 30px –¥–æ 60px)
  const randomSize = 30 + Math.random() * 30;
  if (it.type !== 'png') {
    el.style.fontSize = randomSize + 'px';
  } else {
    el.style.width = randomSize + 'px';
    el.style.height = randomSize + 'px';
  }

  // –°–õ–£–ß–ê–ô–ù–ê–Ø –°–¢–ê–†–¢–û–í–ê–Ø –ü–û–ó–ò–¶–ò–Ø –ü–û –®–ò–†–ò–ù–ï (20% - 80% —ç–∫—Ä–∞–Ω–∞)
  const startX = Math.random() * w * 0.6 + w * 0.2;
  const startY = h + 50;
  const endX = startX + (Math.random() * 80 - 40);
  const endY = h * 0.15 + Math.random() * 120;

  el.style.left = startX + 'px';
  el.style.top  = startY + 'px';
  el.style.opacity = '0';

  layer.appendChild(el);

  const t0 = performance.now();
  const dur = 2500 + Math.random() * 1000;
  const rotationSpeed = (Math.random() - 0.5) * 120;

  (function step(t){
    const k = Math.min(1, (t - t0)/dur);
    const ease = 1 - Math.pow(1-k, 3);

    const x = startX + (endX-startX)*ease;
    const y = startY - (startY-endY)*ease;

    const scale = 0.8 + 0.5*Math.sin(k*Math.PI);

    let opacity;
    if (k < 0.1) opacity = k * 10;
    else if (k > 0.8) opacity = (1-k) * 5;
    else opacity = 1;

    el.style.transform = `translate(${x-startX}px, ${-(startY-y)}px) scale(${scale}) rotate(${rotationSpeed*k}deg)`;
    el.style.opacity = opacity.toFixed(3);

    if (k < 1) requestAnimationFrame(step);
    else el.remove();
  })(performance.now());
}

window.spawnEmoji = spawnEmoji;

  /* ======= CLUSTERING & RENDER ======= */

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è "–ø—Ä–æ–∫–ª—è—Ç–∏—è" (—á–µ—Ä–µ–ø–æ–≤)
  function getSkullLevel(userData) {
    if (!userData || !userData.createdAt) return 0;
    if (userData.isForgiven) return 0; // –ï—Å–ª–∏ –∞–¥–º–∏–Ω –ø—Ä–æ—Å—Ç–∏–ª

    const start = new Date(userData.createdAt);
    const end = new Date();
    let missedSaturdays = 0;

    // –°—á–∏—Ç–∞–µ–º –≤—Å–µ —Å—É–±–±–æ—Ç—ã —Å –º–æ–º–µ–Ω—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ —Å–µ–≥–æ–¥–Ω—è
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      if (d.getDay() === 6) { // 6 = –°—É–±–±–æ—Ç–∞
        const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        // –ï—Å–ª–∏ –≤ —ç—Ç—É —Å—É–±–±–æ—Ç—É –Ω–µ –∑–∞—Ö–æ–¥–∏–ª (–Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ activity)
        if (!userData.activity || !userData.activity[dateKey]) {
          missedSaturdays++;
        }
      }
    }
    // –£—Ä–æ–≤–Ω–∏: 0 (–æ–∫), 1-3 (—á–µ—Ä–µ–ø–∞), 4 (—Å–º–µ—Ä—Ç—å/–±–∞–Ω)
    return Math.min(missedSaturdays, 4);
  }

  // –ú–∞—Å—Å–∏–≤ —ç–º–æ–¥–∑–∏ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
  const SKULL_EMOJIS = ["", "üíÄ", "üíÄüíÄ", "üíÄüíÄüíÄ", "‚ö∞Ô∏è"];

  function getDisplayName(it) {
    if (!it) return '–ß—É–∂–æ–π';
    
    // –ë–µ—Ä–µ–º –∏–º—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –∏—â–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º state
    let rawName = it.name || (it === state ? state.name : '–ß—É–∂–æ–π');
    
    // –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ —á–∏—Å–ª–æ (serverTimestamp), –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥–∞–µ–º –∏–º—è
    if (!it.createdAt || typeof it.createdAt !== 'number') {
      return rawName;
    }

    try {
      const start = new Date(it.createdAt);
      const end = new Date();
      if (isNaN(start.getTime())) return rawName; // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∏–≤—ã—Ö –¥–∞—Ç

      let missedSaturdays = 0;
      // –ö–ª–æ–Ω–∏—Ä—É–µ–º –¥–∞—Ç—É, —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
      let d = new Date(start.getTime());
      while (d <= end) {
        if (d.getDay() === 6) { // –°—É–±–±–æ—Ç–∞
          const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
          if (!it.activity || !it.activity[dateKey]) {
            missedSaturdays++;
          }
        }
        d.setDate(d.getDate() + 1);
      }

      const level = Math.min(missedSaturdays, 4);
      const skulls = ["", "üíÄ", "üíÄüíÄ", "üíÄüíÄüíÄ", "‚ö∞Ô∏è"];
      return rawName + (skulls[level] ? " " + skulls[level] : "");
    } catch (e) {
      return rawName;
    }
  }


  const CLUSTER_DIST_FACTOR = 5.0; // —É–≤–µ–ª–∏—á–∏–ª —Å 3.3 –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–ª–∏–ø–∞–Ω–∏—è
  const clusterAnim = new Map();

  function hexToRgb(hex){
    try{ const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if(!m) return {r:22,g:199,b:183};
      return { r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16) };
    }catch{ return {r:22,g:199,b:183}; }
  }
  function rgba(o,a=1){ return `rgba(${o.r},${o.g},${o.b},${a})`; }
  function darken({r,g,b}, f=0.28){ return { r:Math.round(r*(1-f)), g:Math.round(g*(1-f)), b:Math.round(b*(1-f)) }; }
  function baseRadiusPx(){
    const r=videoRect();
    const d = Math.min(r.w, r.h);
    // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä: –£–ú–ï–ù–¨–®–ï–ù –í 2.5 –†–ê–ó–ê (–±—ã–ª–æ 2.5%, —Å—Ç–∞–ª–æ 1%)
    return Math.max(6, d*0.01);
  }
  function computeClusters(){
    const all = [...state.points.values()];
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö (—É–±—Ä–∞–ª–∏ —Ñ–∏–ª—å—Ç—Ä –æ—Ñ—Ñ–ª–∞–π–Ω)
    const filtered = all;
    
    const br = baseRadiusPx();
    const CLUSTER_DIST = br * CLUSTER_DIST_FACTOR;

    const items = filtered.map(p=>{
      const P = pxFromNorm(p.x,p.y);
      return { id:p.id||p.uid, name:p.name||'', nx:p.x, ny:p.y, x:P.x, y:P.y, color:p.color||DEFAULT_COLOR };
    });


  // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ A –±–ª–∏–∑–∫–æ –∫ B, –∞ B –±–ª–∏–∑–∫–æ –∫ C, —Ç–æ –≤—Å–µ —Ç—Ä–æ–µ –≤ –æ–¥–Ω–æ–º –∫–ª–∞—Å—Ç–µ—Ä–µ
    const used = new Set();
    const clusters = [];
    
    for (let i=0; i<items.length; i++){
      if (used.has(items[i].id)) continue;
      
      const group = [items[i]];
      used.add(items[i].id);
      
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –≥—Ä—É–ø–ø—É, –ø–æ–∫–∞ –Ω–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ –±–ª–∏–∑–∫–∏–µ —Ç–æ—á–∫–∏
      let changed = true;
      while (changed) {
        changed = false;
        for (let j=0; j<items.length; j++){
          if (used.has(items[j].id)) continue;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ –≤ –≥—Ä—É–ø–ø–µ, –±–ª–∏–∑–∫–∞—è –∫ items[j]
          let isNear = false;
          for (const g of group){
            const dx = items[j].x - g.x;
            const dy = items[j].y - g.y;
            if (Math.hypot(dx, dy) <= CLUSTER_DIST){
              isNear = true;
              break;
            }
          }
          
          if (isNear){
            group.push(items[j]);
            used.add(items[j].id);
            changed = true; // –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∏—Å–∫
          }
        }
      }
      
      clusters.push(group);
    }

    return clusters.map(group=>{
      let sx=0, sy=0, snx=0, sny=0;
      const colors = group.map(g=>g.color);
      for (const g of group){ sx+=g.x; sy+=g.y; snx+=g.nx; sny+=g.ny; }
      const cx = sx/group.length, cy=sy/group.length;
      const cnx = snx/group.length, cny=sny/group.length;
      const r = baseRadiusPx() * (1.2 + 1.2*Math.pow(group.length, 0.65)); // –µ—â—ë –±–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä!
      const key = group.map(g=>g.id||g.name).sort().join('|') || (cnx.toFixed(4)+','+cny.toFixed(4));
      return { key, size:group.length, cx, cy, cnx, cny, r, colors, members:group };
    });


  }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function jelly(st){
    if (st.pulse<=0) return 1;
    const t = 1 - st.pulse;
    const c1 = 1.70158, c3 = c1 + 1;
    const overshoot = (1 + c3*Math.pow(t-1,3) + c1*Math.pow(t-1,2));
    return 1 + 0.14*overshoot;
  }
  function animStateFor(key, target){
    const prev = clusterAnim.get(key);
    if (!prev){
      const seed = target.members[0];
      const st = { x: seed?.x ?? target.cx, y: seed?.y ?? target.cy, r: target.r*0.8, size: target.size, pulse: 1 };
      clusterAnim.set(key, st); return st;
    }
    if (prev.size < target.size){ prev.pulse = 1; prev.size = target.size; }
    return prev;
  }
  function stepTowards(st, target, dt){
    const speed = 0.35; // —É–≤–µ–ª–∏—á–∏–ª —Å 0.18 –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
    st.x = lerp(st.x, target.cx, speed);
    st.y = lerp(st.y, target.cy, speed);
    st.r = lerp(st.r, target.r * jelly(st), speed);
    st.pulse = Math.max(0, st.pulse - dt*5.5); // —É–≤–µ–ª–∏—á–∏–ª —Å 3.2 –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞—Ç—É—Ö–∞–Ω–∏—è –ø—É–ª—å—Å–∞
  }

  function drawSingleDot(px, py, radius, colorHex, name){
    const base = hexToRgb(colorHex || DEFAULT_COLOR);
    const dark = darken(base, 0.4);
    const rr = radius * (window.devicePixelRatio||1);

    ctx.save();
    
    // –í–Ω–µ—à–Ω–µ–µ —Å–∏—è–Ω–∏–µ
    const outerGlow = ctx.createRadialGradient(px, py, rr * 0.3, px, py, rr * 1.6);
    outerGlow.addColorStop(0, `rgba(${base.r},${base.g},${base.b},0.3)`);
    outerGlow.addColorStop(0.5, `rgba(${base.r},${base.g},${base.b},0.15)`);
    outerGlow.addColorStop(1, `rgba(${base.r},${base.g},${base.b},0)`);
    ctx.globalCompositeOperation = 'screen';
    ctx.fillStyle = outerGlow;
    ctx.beginPath();
    ctx.arc(px, py, rr * 1.6, 0, Math.PI * 2);
    ctx.fill();

    // –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç (–æ–±—ä–µ–º–Ω—ã–π)
    ctx.globalCompositeOperation = 'source-over';
    const grad = ctx.createRadialGradient(px - rr*0.35, py - rr*0.35, rr*0.1, px, py, rr);
    grad.addColorStop(0.00, 'rgba(255,255,255,0.95)');
    grad.addColorStop(0.15, `rgba(${Math.min(255,base.r+60)},${Math.min(255,base.g+60)},${Math.min(255,base.b+60)},0.9)`);
    grad.addColorStop(0.50, rgba(base, .85));
    grad.addColorStop(0.85, rgba(dark, .75));
    grad.addColorStop(1.00, rgba(darken(base, 0.55), .6));

    ctx.shadowColor = rgba(base, .4);
    ctx.shadowBlur = rr*0.4;

    ctx.beginPath();
    ctx.arc(px, py, rr, 0, Math.PI*2);
    ctx.fillStyle = grad;
    ctx.fill();

    // –¢–æ–Ω–∫–∞—è –æ–±–≤–æ–¥–∫–∞
    ctx.shadowBlur = 0;
    ctx.lineWidth = Math.max(1.5, rr*0.08);
    ctx.strokeStyle = `rgba(${base.r},${base.g},${base.b},0.3)`;
    ctx.stroke();

    // –ë–ª–∏–∫
    const highlight = ctx.createRadialGradient(px - rr*0.3, py - rr*0.3, 0, px - rr*0.3, py - rr*0.3, rr*0.5);
    highlight.addColorStop(0, 'rgba(255,255,255,0.6)');
    highlight.addColorStop(0.6, 'rgba(255,255,255,0.2)');
    highlight.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.globalCompositeOperation = 'screen';
    ctx.fillStyle = highlight;
    ctx.beginPath();
    ctx.arc(px - rr*0.25, py - rr*0.25, rr*0.45, 0, Math.PI*2);
    ctx.fill();

    // –ë—É–∫–≤–∞
    ctx.globalCompositeOperation = 'source-over';
    const letter = (name||'')[0]?.toUpperCase() || '‚Ä¢';
    const fontPx = Math.round(rr * 1.0);
    ctx.font = `900 ${fontPx}px 'Montserrat','Open Sans',sans-serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle = 'rgba(10,15,25,0.85)';
    ctx.shadowColor = 'rgba(255,255,255,0.8)';
    ctx.shadowBlur = Math.max(2, rr*0.15);
    ctx.fillText(letter, px, py);
    
    ctx.restore();
  }

  function drawFrame(){
    const now = performance.now();
    const dt = 0.016; // —É–ø—Ä–æ—â—ë–Ω–Ω–æ

    ctx.clearRect(0,0,canvas.width,canvas.height);

    // DEBUG –∫–æ–¥ —É–¥–∞–ª–µ–Ω

    // strokes - –ü–†–ê–í–ò–õ–¨–ù–ê–Ø —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ timestamp –∏ uid –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ—Ç–æ–º –ø–æ uid –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
    const strokes=[...state.strokes.values()].sort((a,b)=> {
      const timeDiff = (a.ts||0) - (b.ts||0);
      if (timeDiff !== 0) return timeDiff;
      // –ï—Å–ª–∏ –≤—Ä–µ–º—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ uid –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
      return (a.uid||'').localeCompare(b.uid||'');
    });
    const dpr=window.devicePixelRatio||1;
    const currentUid = (auth.currentUser&&auth.currentUser.uid)||state.id;
    
    // –†–∏—Å—É–µ–º –í–°–ï —à—Ç—Ä–∏—Ö–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–≤–∫–ª—é—á–∞—è –ª–∞—Å—Ç–∏–∫–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    for (const s of strokes){
      const pts=s.points||[]; if (pts.length<2) continue;
      
      ctx.save();
      ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=(s.w||4)*dpr;
      
      // –õ–∞—Å—Ç–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ destination-out –¥–ª—è –í–°–ï–•
      if (s.erase){ 
        ctx.globalCompositeOperation='destination-out'; 
        ctx.strokeStyle='rgba(0,0,0,1)'; 
      } else { 
        ctx.globalCompositeOperation='source-over'; 
        ctx.strokeStyle=s.color||DEFAULT_COLOR; 
      }
      
      // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–π
      ctx.beginPath();
      let p0=pxFromNorm(pts[0].x, pts[0].y);
      ctx.moveTo(p0.x, p0.y);
      
      for (let i=1; i<pts.length-1; i++){
        const p1=pxFromNorm(pts[i].x, pts[i].y);
        const p2=pxFromNorm(pts[i+1].x, pts[i+1].y);
        const midX=(p1.x+p2.x)/2;
        const midY=(p1.y+p2.y)/2;
        ctx.quadraticCurveTo(p1.x, p1.y, midX, midY);
      }
      
      if (pts.length>1){
        const last=pxFromNorm(pts[pts.length-1].x, pts[pts.length-1].y);
        ctx.lineTo(last.x, last.y);
      }
      
      ctx.stroke();
      ctx.restore();
    }

    // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π —à—Ç—Ä–∏—Ö (–∂–∏–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞)
    if (state.currentStroke) {
      const s = state.currentStroke;
      const pts = s.points || [];
      if (pts.length >= 2) {
        ctx.save();
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = (s.w || 4) * dpr;
        
        // –¢–µ–∫—É—â–∏–π —à—Ç—Ä–∏—Ö –≤—Å–µ–≥–¥–∞ —Ä–∏—Å—É–µ–º (—ç—Ç–æ –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π)
        if (s.erase) {
          ctx.globalCompositeOperation = 'destination-out';
          ctx.strokeStyle = 'rgba(0,0,0,1)';
        } else {
          ctx.globalCompositeOperation = 'source-over';
          ctx.strokeStyle = s.color || DEFAULT_COLOR;
        }
        
        ctx.beginPath();
        let p0 = pxFromNorm(pts[0].x, pts[0].y);
        ctx.moveTo(p0.x, p0.y);
        
        for (let i = 1; i < pts.length - 1; i++) {
          const p1 = pxFromNorm(pts[i].x, pts[i].y);
          const p2 = pxFromNorm(pts[i + 1].x, pts[i + 1].y);
          const midX = (p1.x + p2.x) / 2;
          const midY = (p1.y + p2.y) / 2;
          ctx.quadraticCurveTo(p1.x, p1.y, midX, midY);
        }
        
        if (pts.length > 1) {
          const last = pxFromNorm(pts[pts.length - 1].x, pts[pts.length - 1].y);
          ctx.lineTo(last.x, last.y);
        }
        
        ctx.stroke();
        ctx.restore();
      }
    }

    // clusters
    const clusters = computeClusters();
    const rot = now/1000 * 0.35;

    for (const c of clusters){
      const st = animStateFor(c.key, c);
      stepTowards(st, c, dt);

      const rr = st.r * (window.devicePixelRatio||1);
      const cx = st.x, cy = st.y;

      if (c.size === 1){
        const p = c.members[0];
        drawSingleDot(cx, cy, rr, p.color || DEFAULT_COLOR, p.name || '–ß—É–∂–æ–π');
        continue;
      }

      // === –°–ï–í–ï–†–ù–û–ï –°–ò–Ø–ù–ò–ï - –¶–í–ï–¢–ù–´–ï –í–û–õ–ù–ò–°–¢–´–ï –õ–ò–ù–ò–ò ===
      ctx.save();

      // 1. –ú–æ—â–Ω–æ–µ –≤–Ω–µ—à–Ω–µ–µ —Å–∏—è–Ω–∏–µ (—á–µ–º –±–æ–ª—å—à–µ –≥–æ–ª–æ—Å–æ–≤, —Ç–µ–º —è—Ä—á–µ)
      const glowIntensity = Math.min(1, 0.3 + c.size * 0.08);
      const glowRadius = rr * (1.5 + c.size * 0.05);
      const outerGlow = ctx.createRadialGradient(cx, cy, rr * 0.5, cx, cy, glowRadius);
      outerGlow.addColorStop(0.0, `rgba(255,255,255,${glowIntensity * 0.4})`);
      outerGlow.addColorStop(0.4, `rgba(220,240,255,${glowIntensity * 0.2})`);
      outerGlow.addColorStop(0.7, `rgba(180,220,255,${glowIntensity * 0.1})`);
      outerGlow.addColorStop(1.0, 'rgba(100,150,255,0)');
      ctx.globalCompositeOperation = 'screen';
      ctx.fillStyle = outerGlow;
      ctx.beginPath();
      ctx.arc(cx, cy, glowRadius, 0, Math.PI * 2);
      ctx.fill();

      // 2. –Ø—Ä–∫–æ–µ —è–¥—Ä–æ
      const coreGrad = ctx.createRadialGradient(cx - rr * 0.25, cy - rr * 0.25, 0, cx, cy, rr * 0.95); // —É–≤–µ–ª–∏—á–∏–ª —Å 0.7 –¥–æ 0.95
      coreGrad.addColorStop(0.0, 'rgba(255,255,255,1)');
      coreGrad.addColorStop(0.4, 'rgba(245,250,255,0.9)');
      coreGrad.addColorStop(0.8, 'rgba(200,225,255,0.5)');
      coreGrad.addColorStop(1.0, 'rgba(150,200,255,0.2)');
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = coreGrad;
      ctx.beginPath();
      ctx.arc(cx, cy, rr * 0.95, 0, Math.PI * 2); // —É–≤–µ–ª–∏—á–∏–ª —Å 0.7 –¥–æ 0.95
      ctx.fill();

      // 3. –¶–í–ï–¢–ù–´–ï –í–û–õ–ù–ò–°–¢–´–ï –õ–ò–ù–ò–ò (–≥–ª–∞–≤–Ω–∞—è —Ñ–∏—à–∫–∞!)
      const palette = [...new Set(c.colors)];
      const numWaves = Math.min(12, palette.length * 3); // –±–æ–ª—å—à–µ –≤–æ–ª–Ω = –±–æ–ª—å—à–µ –∫—Ä–∞—Å–æ—Ç—ã
      
      ctx.globalCompositeOperation = 'screen';
      
      for (let i = 0; i < numWaves; i++) {
        const t = now / 1000;
        const col = palette[i % palette.length];
        const { r: cr, g: cg, b: cb } = hexToRgb(col);
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–æ–ª–Ω—ã
        const waveSpeed = 0.3 + (i % 3) * 0.15;
        const waveFreq = 3 + (i % 4);
        const wavePhase = (i / numWaves) * Math.PI * 2;
        const baseRadius = rr * (0.35 + (i % 5) * 0.08);
        const waveAmplitude = rr * 0.12;
        
        // –†–∏—Å—É–µ–º –≤–æ–ª–Ω–∏—Å—Ç—É—é –ª–∏–Ω–∏—é
        ctx.save();
        ctx.strokeStyle = `rgba(${cr},${cg},${cb},${0.7 + Math.sin(t * 2 + i) * 0.2})`;
        ctx.lineWidth = rr * (0.04 + Math.sin(t * 1.5 + i * 0.5) * 0.02);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // –°–≤–µ—á–µ–Ω–∏–µ –ª–∏–Ω–∏–∏
        ctx.shadowColor = `rgba(${cr},${cg},${cb},0.8)`;
        ctx.shadowBlur = rr * 0.15;
        
        ctx.beginPath();
        const segments = 80;
        for (let s = 0; s <= segments; s++) {
          const angle = (s / segments) * Math.PI * 2 + t * waveSpeed + wavePhase;
          const wave = Math.sin(s / segments * Math.PI * waveFreq + t * 3) * waveAmplitude;
          const radius = baseRadius + wave;
          const x = cx + Math.cos(angle) * radius;
          const y = cy + Math.sin(angle) * radius;
          
          if (s === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.stroke();
        ctx.restore();
      }

      // 4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —è—Ä–∫–∏–µ —Å–∏—è—é—â–∏–µ –∫–æ–ª—å—Ü–∞
      ctx.globalCompositeOperation = 'screen';
      for (let ring = 0; ring < 3; ring++) {
        const ringAlpha = (Math.sin(now / 1000 * (1.2 + ring * 0.4)) * 0.5 + 0.5) * 0.3;
        const ringRad = rr * (0.6 + ring * 0.15);
        
        for (let i = 0; i < palette.length; i++) {
          const col = palette[i];
          const { r: cr, g: cg, b: cb } = hexToRgb(col);
          const angle = (i / palette.length) * Math.PI * 2 + now / 1000 * 0.5 + ring;
          const px = cx + Math.cos(angle) * ringRad;
          const py = cy + Math.sin(angle) * ringRad;
          
          const sparkle = ctx.createRadialGradient(px, py, 0, px, py, rr * 0.2);
          sparkle.addColorStop(0.0, `rgba(${cr},${cg},${cb},${ringAlpha})`);
          sparkle.addColorStop(0.5, `rgba(${cr},${cg},${cb},${ringAlpha * 0.5})`);
          sparkle.addColorStop(1.0, `rgba(${cr},${cg},${cb},0)`);
          ctx.fillStyle = sparkle;
          ctx.beginPath();
          ctx.arc(px, py, rr * 0.2, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // 5. –¢–æ–Ω–∫–∏–π –∫–æ–Ω—Ç—É—Ä - –£–ë–†–ê–õ–ò
      // ctx.globalCompositeOperation = 'source-over';
      // ctx.lineWidth = Math.max(1, rr * 0.02);
      // ctx.strokeStyle = 'rgba(255,255,255,0.3)';
      // ctx.beginPath();
      // ctx.arc(cx, cy, rr * 0.95, 0, Math.PI * 2);
      // ctx.stroke();

      // 6. –ß–∏—Å–ª–æ –≤ —Ü–µ–Ω—Ç—Ä–µ
      ctx.globalCompositeOperation = 'source-over';
      const fontPx = Math.round(rr * 0.65);
      ctx.font = `900 ${fontPx}px 'Montserrat','Open Sans',sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#0a1520';
      ctx.shadowColor = 'rgba(255,255,255,0.9)';
      ctx.shadowBlur = Math.max(3, rr * 0.12);
      ctx.fillText(String(c.size), cx, cy);
      
      ctx.restore();
    }
  }
  function loop(){ drawFrame(); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);

  /* ======= INPUT (vote/draw/erase) - –û–¢–ö–õ–Æ–ß–ï–ù–û –î–õ–Ø OVERLAY –†–ï–ñ–ò–ú–ê ======= */
  canvas.addEventListener('pointerdown', async (e)=>{
    // –•–æ—Å—Ç (overlay) –Ω–µ –º–æ–∂–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å/—Ä–∏—Å–æ–≤–∞—Ç—å
    if (isOverlayMode()) return;
    
    if (!state.authed) return;
    if (state.tool==='vote'){
      e.preventDefault();
      const uid = auth.currentUser?.uid || state.id;
      const pos=normFromEvent(e);
      const p={ id:uid, name: getDisplayName(state)||'–ß—É–∂–æ–π', x:pos.x, y:pos.y, ts:Date.now(), color:state.color };
      state.points.set(uid, p);
      try { await set(ref(db, `${basePath}/points/${uid}`), p); } catch {}
      return;
    }
    if (state.tool==='draw' || state.tool==='erase'){
      e.preventDefault(); beginStroke(e, state.tool==='erase');
    }
  });

  let drawing=false; let currStroke=null;
  let PEN_WIDTH=4;        // –ò–ó–ú–ï–ù–Ø–ï–ú–´–ô —Ä–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏
  let ERASE_WIDTH=20;     // –ò–ó–ú–ï–ù–Ø–ï–ú–´–ô —Ä–∞–∑–º–µ—Ä –ª–∞—Å—Ç–∏–∫–∞
  const MIN_WIDTH=1, MAX_PEN_WIDTH=20, MAX_ERASE_WIDTH=50;
  
  // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–º
  const brushSizeSlider = document.getElementById('brushSizeSlider');
  const brushSizeValue = document.getElementById('brushSizeValue');
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞
  brushSizeSlider.addEventListener('input', (e) => {
    const size = parseInt(e.target.value);
    if (state.tool === 'draw') {
      PEN_WIDTH = size;
      brushSizeValue.textContent = size + 'px';
    } else if (state.tool === 'erase') {
      ERASE_WIDTH = size;
      brushSizeValue.textContent = size + 'px';
    }
  });
  function beginStroke(e, erase=false){
    drawing=true;
    const p=normFromEvent(e);
    const uid=(auth.currentUser&&auth.currentUser.uid)||state.id;
    const width = erase ? ERASE_WIDTH : PEN_WIDTH; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä
    currStroke={ uid, name: getDisplayName(state)||'–ß—É–∂–æ–π', color:state.color, erase, w: width, points:[p], ts:Date.now() };
    state.currentStroke = currStroke; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ state –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
  }
  function moveStroke(e){ 
    if(!drawing||!currStroke) return; 
    const p=normFromEvent(e); 
    currStroke.points.push(p);
    state.currentStroke = currStroke; // –û–±–Ω–æ–≤–ª—è–µ–º –≤ state
  }
  
  // –£–±—Ä–∞–ª drawLiveStroke - —Ç–µ–ø–µ—Ä—å —Ä–∏—Å—É–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ
  async function endStroke(){
    if(!drawing||!currStroke) return;
    
    // –ï—Å–ª–∏ —ç—Ç–æ –ª–∞—Å—Ç–∏–∫, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏ —É–¥–∞–ª—è–µ–º –¢–û–õ–¨–ö–û –°–í–û–ò —à—Ç—Ä–∏—Ö–∏
    if(currStroke.erase){
      const currentUid = (auth.currentUser&&auth.currentUser.uid)||state.id;
      const eraserPts = currStroke.points || [];
      
      // –ù–∞—Ö–æ–¥–∏–º —à—Ç—Ä–∏—Ö–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
      const toDelete = [];
      for(const [key, stroke] of state.strokes.entries()){
        // –°—Ç–∏—Ä–∞–µ–º –¢–û–õ–¨–ö–û —Å–≤–æ–∏ —à—Ç—Ä–∏—Ö–∏
        if(stroke.uid !== currentUid) continue;
        if(stroke.erase) continue; // –ù–µ —Ç—Ä–æ–≥–∞–µ–º –¥—Ä—É–≥–∏–µ –ª–∞—Å—Ç–∏–∫–∏
        
        const strokePts = stroke.points || [];
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
        let intersects = false;
        for(const ep of eraserPts){
          for(const sp of strokePts){
            const dx = ep.x - sp.x;
            const dy = ep.y - sp.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            // –ü–æ—Ä–æ–≥ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ª–∞—Å—Ç–∏–∫–∞
            const threshold = (currStroke.w || 20) * 0.015; // ~1.5% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ canvas
            if(dist < threshold){
              intersects = true;
              break;
            }
          }
          if(intersects) break;
        }
        
        if(intersects){
          toDelete.push(key);
        }
      }
      
      // –£–¥–∞–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏
      try{
        for(const key of toDelete){
          await remove(ref(db, `${basePath}/strokes/${key}`));
          state.strokes.delete(key);
        }
      }catch(e){
        console.error('Failed to erase strokes:', e);
      }
    } else {
      // –û–±—ã—á–Ω—ã–π —à—Ç—Ä–∏—Ö - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
      try{
        const key = push(strokesRoot).key;
        await update(ref(db, `${basePath}/strokes/${key}`), currStroke);
      }catch{}
    }
    
    drawing=false; currStroke=null;
    state.currentStroke = null; // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —à—Ç—Ä–∏—Ö
  }
  canvas.addEventListener('pointermove', (e)=>{ if(state.tool==='draw'||state.tool==='erase') moveStroke(e); });
  window.addEventListener('pointerup', endStroke);
  window.addEventListener('pointercancel', endStroke);
  
  // –û—Ç–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª –Ω–∞ canvas –∏ —á–∞—Ç–µ (–º–æ–±–∏–ª—å–Ω—ã–µ)
  canvas.addEventListener('touchstart', e => e.preventDefault(), {passive: false});
  canvas.addEventListener('touchmove', e => e.preventDefault(), {passive: false});
  chatPanel.addEventListener('touchstart', e => e.stopPropagation());
  chatPanel.addEventListener('touchmove', e => e.stopPropagation());

  /* ======= DRAGGABLE CHAT (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç–∞—á—Å–∫—Ä–∏–Ω–∞) ======= */
  (function enableDrag(){
    let startX=0, startY=0, baseLeft=chatPanel.offsetLeft, baseTop=chatPanel.offsetTop, dragging=false;
    const saved=localStorage.getItem('cc_chat_pos'); 
    if(saved){ 
      try{
        const {left,top}=JSON.parse(saved); 
        chatPanel.style.left=left+'px'; 
        chatPanel.style.top=top+'px';
      }catch{} 
    }
    
    function onDown(e){ 
      e.preventDefault();
      dragging=true; 
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      startX=clientX; 
      startY=clientY; 
      baseLeft=chatPanel.offsetLeft; 
      baseTop=chatPanel.offsetTop; 
      document.addEventListener('pointermove', onMove); 
      document.addEventListener('pointerup', onUp); 
      document.addEventListener('touchmove', onMove, {passive: false});
      document.addEventListener('touchend', onUp);
    }
    
    function onMove(e){ 
      if(!dragging) return; 
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const dx=clientX-startX, dy=clientY-startY; 
      let l=baseLeft+dx, t=baseTop+dy; 
      const margin=6; 
      l=Math.max(margin, Math.min(window.innerWidth - chatPanel.offsetWidth - margin, l)); 
      t=Math.max(margin, Math.min(window.innerHeight - chatPanel.offsetHeight - margin, t)); 
      chatPanel.style.left=l+'px'; 
      chatPanel.style.top=t+'px'; 
    }
    
    function onUp(){ 
      dragging=false; 
      document.removeEventListener('pointermove', onMove); 
      document.removeEventListener('pointerup', onUp); 
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
      localStorage.setItem('cc_chat_pos', JSON.stringify({ 
        left: chatPanel.offsetLeft, 
        top: chatPanel.offsetTop 
      })); 
    }
    
    chatDragHandle.addEventListener('pointerdown', onDown);
  })();

  /* ======= STARTUP ======= */
  if (state.localChat.length){ renderChat(state.localChat.slice(-100)); }

  const url = new URL(FIXED_VIEW);
  if(!url.searchParams.get('cleanoutput')) url.searchParams.set('cleanoutput','1');
  if(!url.searchParams.get('stats')) url.searchParams.set('stats','0');
  if (!isOverlayMode()) $player.src = url.toString();

  setTool(state.tool || 'vote');
  
  /* ============= TELEGRAM –ü–†–ò–í–Ø–ó–ö–ê ============= */
  
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–æ–¥–∞ –ø—Ä–∏–≤—è–∑–∫–∏
  function generateLinkCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = 'LINK-';
    for (let i = 0; i < 4; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  async function checkTelegramLink() {
    if (!auth.currentUser) return null;
    
    try {
      const linksRef = ref(db, `${basePath}/telegram_links/${state.id}`);
      const snapshot = await get(linksRef);
      
      if (snapshot.exists()) {
        const linkData = snapshot.val();
        console.log('‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω –∫ Telegram:', linkData);
        return linkData;
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–≤—è–∑–∫–∏:', e);
    }
    
    return null;
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–≤—è–∑–∫–∏
  function updateLinkButton(linkData) {
    const linkBtn = document.getElementById('linkTelegramBtn');
    if (!linkBtn) return;
    
    if (linkData) {
      linkBtn.innerHTML = '‚úÖ TG';
      linkBtn.classList.add('linked');
      linkBtn.title = `–ü—Ä–∏–≤—è–∑–∞–Ω –∫ @${linkData.tgUsername || linkData.tgFirstName}`;
    } else {
      linkBtn.innerHTML = 'üîó TG';
      linkBtn.classList.remove('linked');
      linkBtn.title = '–°–≤—è–∑–∞—Ç—å —Å Telegram';
    }
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –≤ Firebase
  async function createLinkCode() {
    if (!auth.currentUser) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ –Ω–∞ —Å–∞–π—Ç!');
      return null;
    }
    
    const code = generateLinkCode();
    const codeData = {
      userId: state.id,
      name: getDisplayName(state) || '–ß—É–∂–æ–π',
      color: state.color,
      createdAt: Date.now(),
      expiresAt: Date.now() + (5 * 60 * 1000), // 5 –º–∏–Ω—É—Ç
      used: false
    };
    
    try {
      const codesRef = ref(db, `${basePath}/link_codes/${code}`);
      await set(codesRef, codeData);
      console.log('‚úÖ –ö–æ–¥ —Å–æ–∑–¥–∞–Ω:', code);
      return code;
    } catch (e) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–¥–∞:', e);
      return null;
    }
  }
  
  // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤—è–∑–∫–∏
  window.showLinkModal = async function() {
    const modal = document.getElementById('linkModal');
    const linkCodeEl = document.getElementById('linkCode');
    const linkInfo = document.getElementById('linkInfo');
    const linkNewBtn = document.getElementById('linkNewCodeBtn');
    const unlinkBtn = document.getElementById('unlinkBtn');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –ø—Ä–∏–≤—è–∑–∫—É
    const currentLink = await checkTelegramLink();
    
    if (currentLink) {
      // –£–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      linkInfo.classList.remove('hidden');
      linkCodeEl.parentElement.classList.add('hidden');
      linkNewBtn.classList.add('hidden');
      unlinkBtn.classList.remove('hidden');
      
      document.getElementById('linkInfoName').textContent = currentLink.tgFirstName;
      document.getElementById('linkInfoUsername').textContent = 
        currentLink.tgUsername ? `@${currentLink.tgUsername}` : '–ù–µ —É–∫–∞–∑–∞–Ω';
      
      const linkedDate = new Date(currentLink.linkedAt);
      document.getElementById('linkInfoDate').textContent = 
        linkedDate.toLocaleDateString('ru-RU') + ' ' + linkedDate.toLocaleTimeString('ru-RU');
    } else {
      // –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥
      linkInfo.classList.add('hidden');
      linkCodeEl.parentElement.classList.remove('hidden');
      linkNewBtn.classList.remove('hidden');
      unlinkBtn.classList.add('hidden');
      
      const code = await createLinkCode();
      if (code) {
        linkCodeEl.textContent = code;
      } else {
        linkCodeEl.textContent = '–û—à–∏–±–∫–∞';
      }
    }
    
    modal.classList.add('show');
  }
  
  // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  window.closeLinkModal = function() {
    const modal = document.getElementById('linkModal');
    modal.classList.remove('show');
  }
  
  // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
  window.copyLinkCode = function() {
    const linkCodeEl = document.getElementById('linkCode');
    const code = linkCodeEl.textContent;
    
    navigator.clipboard.writeText(code).then(() => {
      const originalText = linkCodeEl.textContent;
      linkCodeEl.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      linkCodeEl.style.color = '#22c55e';
      
      setTimeout(() => {
        linkCodeEl.textContent = originalText;
        linkCodeEl.style.color = '';
      }, 2000);
    }).catch(err => {
      alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é: ' + code);
    });
  }
  
  // –û—Ç–≤—è–∑–∞—Ç—å Telegram
  window.unlinkTelegram = async function() {
    if (!confirm('–û—Ç–≤—è–∑–∞—Ç—å Telegram –∞–∫–∫–∞—É–Ω—Ç?')) return;
    
    try {
      const linksRef = ref(db, `${basePath}/telegram_links/${state.id}`);
      await remove(linksRef);
      
      alert('‚úÖ Telegram –æ—Ç–≤—è–∑–∞–Ω!');
      closeLinkModal();
      updateLinkButton(null);
      
      console.log('‚úÖ –û—Ç–≤—è–∑–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
    } catch (e) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏:', e);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.');
    }
  }
  
  // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥
  window.generateNewCode = async function() {
    const linkCodeEl = document.getElementById('linkCode');
    linkCodeEl.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
    
    const code = await createLinkCode();
    if (code) {
      linkCodeEl.textContent = code;
    } else {
      linkCodeEl.textContent = '–û—à–∏–±–∫–∞';
    }
  }
  
  // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏–≤—è–∑–∫–∏ (—Ä–µ–∞–ª—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
  function listenToLinkChanges() {
    if (!auth.currentUser) return;
    
    const linksRef = ref(db, `${basePath}/telegram_links/${state.id}`);
    
    onValue(linksRef, async (snapshot) => {
      if (snapshot.exists()) {
        const linkData = snapshot.val();
        updateLinkButton(linkData);
        
        // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ —Å –∫–æ–¥–æ–º - –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ—ë –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
        const modal = document.getElementById('linkModal');
        const linkCodeEl = document.getElementById('linkCode');
        
        if (modal.classList.contains('show') && 
            linkCodeEl.textContent.startsWith('LINK-')) {
          closeLinkModal();
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
            z-index: 10000;
            font-weight: 700;
            animation: slideIn 0.3s ease;
          `;
          notification.innerHTML = `
            ‚úÖ Telegram —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω!<br>
            <span style="font-size: 0.9em; opacity: 0.9;">@${linkData.tgUsername || linkData.tgFirstName}</span>
          `;
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
          }, 4000);
        }
      } else {
        updateLinkButton(null);
      }
    });
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –ø—Ä–∏–≤—è–∑–∫–∏
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–≤—è–∑–∫—É
      const linkData = await checkTelegramLink();
      updateLinkButton(linkData);
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å
      listenToLinkChanges();
    }
  });
  
  // –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  const telegramAnimStyle = document.createElement('style');
  telegramAnimStyle.textContent = `
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100px);
      }
    }
  `;
  document.head.appendChild(telegramAnimStyle);
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram -->
<div class="link-modal" id="linkModal" onclick="if(event.target===this) closeLinkModal()">
  <div class="link-modal-content">
    <h3>üîó –°–≤—è–∑–∞—Ç—å —Å Telegram</h3>
    
    <!-- –ï—Å–ª–∏ –ù–ï –ø—Ä–∏–≤—è–∑–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ -->
    <div id="linkCodeSection">
      <p>
        –û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥ –±–æ—Ç—É –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
      </p>
      
      <div class="link-code" id="linkCode" onclick="copyLinkCode()">
        LINK-XXXX
      </div>
      
      <p class="link-hint">
        üí° –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç<br>
        üîÑ –ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫–æ–¥, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
      </p>
      
      <div class="link-modal-buttons">
        <button class="btn small" onclick="copyLinkCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn ghost small" id="linkNewCodeBtn" onclick="generateNewCode()">üîÑ –ù–æ–≤—ã–π –∫–æ–¥</button>
        <button class="btn ghost small" onclick="closeLinkModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    
    <!-- –ï—Å–ª–∏ –£–ñ–ï –ø—Ä–∏–≤—è–∑–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é -->
    <div id="linkInfo" class="link-info hidden">
      <div style="text-align: center; margin-bottom: 16px;">
        <span class="link-status linked">‚úÖ –ü—Ä–∏–≤—è–∑–∞–Ω</span>
      </div>
      
      <div class="link-info-row">
        <span class="link-info-label">üë§ –ò–º—è:</span>
        <span class="link-info-value" id="linkInfoName">‚Äî</span>
      </div>
      
      <div class="link-info-row">
        <span class="link-info-label">üì± Username:</span>
        <span class="link-info-value" id="linkInfoUsername">‚Äî</span>
      </div>
      
      <div class="link-info-row">
        <span class="link-info-label">üìÖ –ü—Ä–∏–≤—è–∑–∞–Ω–æ:</span>
        <span class="link-info-value" id="linkInfoDate">‚Äî</span>
      </div>
      
      <div class="link-modal-buttons" style="margin-top: 20px;">
        <button class="btn danger small" id="unlinkBtn" onclick="unlinkTelegram()">
          üîì –û—Ç–≤—è–∑–∞—Ç—å
        </button>
        <button class="btn ghost small" onclick="closeLinkModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
